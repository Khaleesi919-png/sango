<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>三國志戰略版配將模擬器 Cyber</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
            },
            colors: {
              cyber: {
                bg: '#050505',
                panel: '#151515', 
                card: '#1a1a1a',
                text: '#f0f0f0', 
                dim: '#aaaaaa',
                cyan: '#00f3ff',
                pink: '#ff00ff',
                yellow: '#fcee0a',
                red: '#ff2a2a',
                green: '#00ff9f',
                border: '#666666',
              },
              wei: '#00a8ff',
              shu: '#00ff9f',
              wu: '#ff2a2a',
              qun: '#fcee0a',
              t_command: '#8e44ad',
              t_passive: '#2980b9',
              t_formation: '#f39c12',
              t_assault: '#c0392b',
              t_troop: '#27ae60',
              t_active: '#16a085',
            },
            boxShadow: {
              'neon-cyan': '0 0 5px #00f3ff, 0 0 10px #00f3ff',
              'neon-pink': '0 0 5px #ff00ff, 0 0 10px #ff00ff',
              'neon-yellow': '0 0 5px #fcee0a, 0 0 10px #fcee0a',
              'neon-red': '0 0 5px #ff2a2a, 0 0 10px #ff2a2a',
            },
            animation: {
              'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'glitch': 'glitch 1s linear infinite',
              'scanline': 'scanline 8s linear infinite',
              'slide-up': 'slideUp 0.3s ease-out forwards',
            },
            keyframes: {
              glitch: {
                '2%, 64%': { transform: 'translate(2px,0) skew(0deg)' },
                '4%, 60%': { transform: 'translate(-2px,0) skew(0deg)' },
                '62%': { transform: 'translate(0,0) skew(5deg)' },
              },
              scanline: {
                '0%': { transform: 'translateY(-100%)' },
                '100%': { transform: 'translateY(100%)' }
              },
              slideUp: {
                'from': { transform: 'translateY(20px)', opacity: '0' },
                'to': { transform: 'translateY(0)', opacity: '1' }
              }
            }
          }
        }
      }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
      html, body {
        min-height: 100%;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        background-color: #050505;
        color: #e0e0e0;
        -webkit-font-smoothing: antialiased;
        overflow-x: hidden;
      }
      
      /* Cyber Grid Background */
      .cyber-grid {
        background-size: 40px 40px;
        background-image: linear-gradient(to right, rgba(0, 243, 255, 0.05) 1px, transparent 1px),
                          linear-gradient(to bottom, rgba(0, 243, 255, 0.05) 1px, transparent 1px);
        background-attachment: fixed;
        min-height: 100vh;
      }

      .cyber-card {
        background: rgba(20, 20, 20, 0.9);
        border: 1px solid rgba(0, 243, 255, 0.3);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
        position: relative;
        overflow: hidden;
      }
      
      .cyber-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, #00f3ff, transparent);
        opacity: 0.5;
      }

      /* Angled buttons */
      .clip-path-btn {
        clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
      }
      
      .clip-path-polygon {
        clip-path: polygon(15% 0, 100% 0, 100% 85%, 85% 100%, 0 100%, 0 15%);
      }

      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0"
  }
}
</script>
</head>
<body class="cyber-grid">
    <!-- Left Top Annotation -->
    <div class="fixed top-4 left-6 z-[60] text-cyber-cyan font-bold text-[10px] tracking-[0.2em] pointer-events-none opacity-80 font-mono drop-shadow-[0_0_5px_rgba(0,243,255,0.8)]">
      Q做的
    </div>

    <!-- App Container -->
    <div id="app" class="min-h-screen pb-40 px-4 max-w-7xl mx-auto flex flex-col font-mono text-cyber-text"></div>

    <!-- Scripts -->
    <script>
      // --- Constants ---
      const Faction = {
        Wei: '魏',
        Shu: '蜀',
        Wu: '吳',
        Qun: '群'
      };

      const TacticType = {
        Command: '指揮',
        Passive: '被動',
        Formation: '陣法',
        Assault: '突擊',
        Troop: '兵種',
        Active: '主動'
      };

      const GENERALS_DATA = [
        // 蜀
        { faction: Faction.Shu, name: '劉備 7' }, { faction: Faction.Shu, name: '龐統 7' }, { faction: Faction.Shu, name: '諸葛亮 7' }, { faction: Faction.Shu, name: 'SP諸葛亮 6' }, { faction: Faction.Shu, name: '關羽 7' }, { faction: Faction.Shu, name: 'SP關羽 7' }, { faction: Faction.Shu, name: 'SP黃月英 4' }, { faction: Faction.Shu, name: '黃忠 6' }, { faction: Faction.Shu, name: 'SP黃忠 6' }, { faction: Faction.Shu, name: '趙雲 6' }, { faction: Faction.Shu, name: '張飛 6' }, { faction: Faction.Shu, name: '姜維 6' }, { faction: Faction.Shu, name: '關銀屏 6' }, { faction: Faction.Shu, name: '魏延 6' }, { faction: Faction.Shu, name: '張苞 6' }, { faction: Faction.Shu, name: '關興 6' }, { faction: Faction.Shu, name: 'SP法正 6' }, { faction: Faction.Shu, name: '星彩 6' },{ faction: Faction.Shu, name: '法正 4' }, { faction: Faction.Shu, name: '王平 5' }, { faction: Faction.Shu, name: '徐庶 5' }, { faction: Faction.Shu, name: '黃月英 4' }, { faction: Faction.Shu, name: '馬超 7' }, { faction: Faction.Shu, name: 'CO關平 6' }, { faction: Faction.Shu, name: '馬雲祿 5' }, { faction: Faction.Shu, name: '陳到 6' }, { faction: Faction.Shu, name: '嚴顏 6' }, { faction: Faction.Shu, name: '伊籍 6' },
        // 魏
        { faction: Faction.Wei, name: '司馬懿 7' }, { faction: Faction.Wei, name: '曹操 7' }, { faction: Faction.Wei, name: '滿寵 5' }, { faction: Faction.Wei, name: '典韋 6' }, { faction: Faction.Wei, name: 'SP典韋 6' }, { faction: Faction.Wei, name: '賈詡 7' }, { faction: Faction.Wei, name: 'SP荀彧 7' }, { faction: Faction.Wei, name: 'SP郭嘉 6' }, { faction: Faction.Wei, name: '荀攸 6' }, { faction: Faction.Wei, name: '張遼 7' }, { faction: Faction.Wei, name: '王元姬 5' }, { faction: Faction.Wei, name: '郭嘉 5' }, { faction: Faction.Wei, name: '王異 6' }, { faction: Faction.Wei, name: '龐德 5' }, { faction: Faction.Wei, name: 'SP龐德 6' }, { faction: Faction.Wei, name: 'CO曹丕 7' }, { faction: Faction.Wei, name: '郝昭 5' }, { faction: Faction.Wei, name: '曹仁 6' }, { faction: Faction.Wei, name: 'CO甄姬 5' }, { faction: Faction.Wei, name: '程昱 5' }, { faction: Faction.Wei, name: '許褚 6' }, { faction: Faction.Wei, name: '張郃 6' }, { faction: Faction.Wei, name: '徐晃 6' }, { faction: Faction.Wei, name: '夏侯惇 6' }, { faction: Faction.Wei, name: '鍾會 6' }, { faction: Faction.Wei, name: '王雙 5' }, { faction: Faction.Wei, name: '曹純 5' }, { faction: Faction.Wei, name: '于禁 5' }, { faction: Faction.Wei, name: '樂進 5' }, { faction: Faction.Wei, name: '鄧艾 5' }, { faction: Faction.Wei, name: '夏侯淵 5' }, { faction: Faction.Wei, name: '張春華 3' }, { faction: Faction.Wei, name: 'SP劉曄 6' }, { faction: Faction.Wei, name: 'SP曹真 6' },
        // 吳
        { faction: Faction.Wu, name: '孫尚香 6' }, { faction: Faction.Wu, name: '周泰 6' }, { faction: Faction.Wu, name: '凌統 6' }, { faction: Faction.Wu, name: '陸遜 7' }, { faction: Faction.Wu, name: '魯肅 6' }, { faction: Faction.Wu, name: '周瑜 6' }, { faction: Faction.Wu, name: 'SP周瑜 6' }, { faction: Faction.Wu, name: '孫權 6' }, { faction: Faction.Wu, name: 'CO大喬 6' }, { faction: Faction.Wu, name: 'CO小喬 5' }, { faction: Faction.Wu, name: '呂蒙 6' }, { faction: Faction.Wu, name: 'SP呂蒙 7' }, { faction: Faction.Wu, name: '太史慈 6' }, { faction: Faction.Wu, name: '孫堅 6' }, { faction: Faction.Wu, name: 'SP孫堅 7' }, { faction: Faction.Wu, name: '甘寧 6' }, { faction: Faction.Wu, name: '程普 5' }, { faction: Faction.Wu, name: '陸抗 6' }, { faction: Faction.Wu, name: '黃蓋 5' }, { faction: Faction.Wu, name: '諸葛格 4' }, { faction: Faction.Wu, name: '孫策 5' },
        // 群
        { faction: Faction.Qun, name: 'SP馬超 7' }, { faction: Faction.Qun, name: 'SP皇甫嵩 6' }, { faction: Faction.Qun, name: 'SP袁紹 7' }, { faction: Faction.Qun, name: 'SP朱儁 6' }, { faction: Faction.Qun, name: '沮授 6' }, { faction: Faction.Qun, name: '貂蟬 4' }, { faction: Faction.Qun, name: 'SP貂蟬 6' }, { faction: Faction.Qun, name: '許攸 6' }, { faction: Faction.Qun, name: '呂布 7' }, { faction: Faction.Qun, name: '袁術 6' }, { faction: Faction.Qun, name: '公孫瓚 6' }, { faction: Faction.Qun, name: '張角 6' }, { faction: Faction.Qun, name: '于吉 7' }, { faction: Faction.Qun, name: '華佗 5' }, { faction: Faction.Qun, name: '左慈 5' }, { faction: Faction.Qun, name: '董卓 7' }, { faction: Faction.Qun, name: 'SP董卓 7' }, { faction: Faction.Qun, name: '孟獲 7' }, { faction: Faction.Qun, name: '呂玲綺 6' }, { faction: Faction.Qun, name: '祝融夫人 6' }, { faction: Faction.Qun, name: '兀突骨 6' }, { faction: Faction.Qun, name: '袁紹 6' }, { faction: Faction.Qun, name: '麴義 6' }, { faction: Faction.Qun, name: '朵思大王 6' }, { faction: Faction.Qun, name: '木鹿大王 6' }, { faction: Faction.Qun, name: '張讓 5' }, { faction: Faction.Qun, name: '李儒 5' }, { faction: Faction.Qun, name: '高順 5' }, { faction: Faction.Qun, name: '馬騰 5' }, { faction: Faction.Qun, name: '文醜 5' }, { faction: Faction.Qun, name: '華雄 5' }, { faction: Faction.Qun, name: '顏良 5' }, { faction: Faction.Qun, name: '高覽 5' }, { faction: Faction.Qun, name: '陳宮 5' }, { faction: Faction.Qun, name: '蔡文姬 3' }, { faction: Faction.Qun, name: '董白 3' }, { faction: Faction.Qun, name: 'SP張寶 6' }, { faction: Faction.Qun, name: 'SP張梁 5' }, { faction: Faction.Qun, name: '田豐 6' }, { faction: Faction.Qun, name: '兲丨Q 30' }, { faction: Faction.Qun, name: '雞枝風 3CM' }, { faction: Faction.Qun, name: '大麥克 3CM' }, { faction: Faction.Qun, name: '鄒氏 3' }
      ];

      const TACTICS_DATA = [
        { type: TacticType.Command, name: '虛實奇謀' }, { type: TacticType.Command, name: '深謀遠慮' }, { type: TacticType.Command, name: '蓄勢待發' }, { type: TacticType.Command, name: '暫避其鋒' }, { type: TacticType.Command, name: '轉.暫避統' }, { type: TacticType.Command, name: '盛氣淩敵' }, { type: TacticType.Command, name: '用武神通' }, { type: TacticType.Command, name: '轉.用武武' }, { type: TacticType.Command, name: '夢中弒臣' }, { type: TacticType.Command, name: '挫銳' }, { type: TacticType.Command, name: '非攻制勝' }, { type: TacticType.Command, name: '轉.非攻智' }, { type: TacticType.Command, name: '鐵騎驅馳' }, { type: TacticType.Command, name: '撫輯軍民' }, { type: TacticType.Command, name: '轉.撫輯智' },{ type: TacticType.Command, name: '禦敵屏障' }, { type: TacticType.Command, name: '長者之風' }, { type: TacticType.Command, name: '鋒芒畢露' }, { type: TacticType.Command, name: '整裝待發' }, { type: TacticType.Command, name: '義心昭烈' }, { type: TacticType.Command, name: '奇計良謀' }, { type: TacticType.Command, name: '橫戈躍馬' }, { type: TacticType.Command, name: '整軍經武' }, { type: TacticType.Command, name: '剛柔並濟' }, { type: TacticType.Command, name: '眾志成城' }, { type: TacticType.Command, name: '轉.眾志武' },{ type: TacticType.Command, name: '知己知彼' },
        { type: TacticType.Passive, name: '功不唐捐' }, { type: TacticType.Passive, name: '整軍經武' }, { type: TacticType.Passive, name: '千里走單騎' }, { type: TacticType.Passive, name: '魅惑' }, { type: TacticType.Passive, name: '合軍聚眾' }, { type: TacticType.Passive, name: '忠勇益烈' }, { type: TacticType.Passive, name: '文武雙全' }, { type: TacticType.Passive, name: '以寡擊眾' }, { type: TacticType.Passive, name: '絕地反擊' }, { type: TacticType.Passive, name: '士爭先赴' }, { type: TacticType.Passive, name: '裸衣血戰' }, { type: TacticType.Passive, name: '血刃爭鋒' }, { type: TacticType.Passive, name: '眾動萬計' }, { type: TacticType.Passive, name: '太平道法' }, { type: TacticType.Passive, name: '自癒' }, { type: TacticType.Passive, name: '後發制人' }, { type: TacticType.Passive, name: '氣凌三軍' }, { type: TacticType.Passive, name: '虎踞鷹揚' }, { type: TacticType.Passive, name: '引弦力戰' }, { type: TacticType.Passive, name: '剛勇無前' }, { type: TacticType.Passive, name: '騎虎難下' }, { type: TacticType.Passive, name: '白眉' }, { type: TacticType.Passive, name: '兵無常勢' }, { type: TacticType.Passive, name: '士別三日' }, { type: TacticType.Passive, name: '乘勝長驅' },
        { type: TacticType.Formation, name: '潛龍陣' }, { type: TacticType.Formation, name: '鋒矢陣' }, { type: TacticType.Formation, name: '八門金鎖陣' }, { type: TacticType.Formation, name: '箕形陣' }, { type: TacticType.Formation, name: '三勢陣' }, { type: TacticType.Formation, name: '行一陣' }, { type: TacticType.Formation, name: '武鋒陣' }, { type: TacticType.Formation, name: '長蛇陣' }, { type: TacticType.Formation, name: '魚鱗陣' },
        { type: TacticType.Assault, name: '摧鋒斷刃' }, { type: TacticType.Assault, name: '折衝禦侮' }, { type: TacticType.Assault, name: '暴戾無仁' }, { type: TacticType.Assault, name: '一騎當千' }, { type: TacticType.Assault, name: '百騎劫營' }, { type: TacticType.Assault, name: '當鋒摧決' }, { type: TacticType.Assault, name: '速乘其利' }, { type: TacticType.Assault, name: '彎弓飲羽' }, { type: TacticType.Assault, name: '鬼神霆威' }, { type: TacticType.Assault, name: '破甲' }, { type: TacticType.Assault, name: '克敵制勝' }, { type: TacticType.Assault, name: '先成其慮' }, { type: TacticType.Assault, name: '勇者得前' }, { type: TacticType.Assault, name: '左右開弓' }, { type: TacticType.Assault, name: '手起刀落' },
        { type: TacticType.Troop, name: '虎豹騎' }, { type: TacticType.Troop, name: '大戟士' }, { type: TacticType.Troop, name: '藤甲兵' }, { type: TacticType.Troop, name: '白馬義從' }, { type: TacticType.Troop, name: '先登士死' }, { type: TacticType.Troop, name: '陷陣營' }, { type: TacticType.Troop, name: '西涼鐵騎' }, { type: TacticType.Troop, name: '解煩衛' }, { type: TacticType.Troop, name: '錦帆軍' }, { type: TacticType.Troop, name: '飛熊軍' }, { type: TacticType.Troop, name: '象兵' }, { type: TacticType.Troop, name: '青州兵' }, { type: TacticType.Troop, name: '虎衛軍' }, { type: TacticType.Troop, name: '白毦兵' }, { type: TacticType.Troop, name: '無當飛軍' }, { type: TacticType.Troop, name: '丹陽兵' },
        { type: TacticType.Active, name: '偽書相間' }, { type: TacticType.Active, name: '挾勢弄權' }, { type: TacticType.Active, name: '奪魂挾魄' }, { type: TacticType.Active, name: '轉.奪魂武' }, { type: TacticType.Active, name: '草船借箭' }, { type: TacticType.Active, name: '刮骨療傷' }, { type: TacticType.Active, name: '轉.刮骨統' },{ type: TacticType.Active, name: '嬰城自守' }, { type: TacticType.Active, name: '坐守孤城' }, { type: TacticType.Active, name: '杯蛇鬼車' }, { type: TacticType.Active, name: '竭力佐謀' }, { type: TacticType.Active, name: '因利制權' }, { type: TacticType.Active, name: '誘敵深入' }, { type: TacticType.Active, name: '威謀靡亢' }, { type: TacticType.Active, name: '挫志怒襲' }, { type: TacticType.Active, name: '乘敵不虞' }, { type: TacticType.Active, name: '傾國傾城' }, { type: TacticType.Active, name: '益其金鼓' }, { type: TacticType.Active, name: '定謀貴決' }, { type: TacticType.Active, name: '結盟' }, { type: TacticType.Active, name: '臨機制勝' }, { type: TacticType.Active, name: '熯天熾熱' }, { type: TacticType.Active, name: '火熾原燎' }, { type: TacticType.Active, name: '風助火勢' }, { type: TacticType.Active, name: '智計' }, { type: TacticType.Active, name: '兵鋒' }, { type: TacticType.Active, name: '上兵伐謀' }, { type: TacticType.Active, name: '破軍威勝' }, { type: TacticType.Active, name: '掣刀斫敵' }, { type: TacticType.Active, name: '臥薪嘗膽' }, { type: TacticType.Active, name: '縱兵劫掠' }, { type: TacticType.Active, name: '橫掃千軍' }, { type: TacticType.Active, name: '轉.橫掃智' },  { type: TacticType.Active, name: '疾風驟雨' },{ type: TacticType.Active, name: '焚輜營壘' }, { type: TacticType.Active, name: '萬軍奪帥' }, { type: TacticType.Active, name: '靈機一動' }, { type: TacticType.Active, name: '謬力同心' }, { type: TacticType.Active, name: '強攻' }, { type: TacticType.Active, name: '淨化' }, { type: TacticType.Active, name: '驅散' }, { type: TacticType.Active, name: '魯莽' }, { type: TacticType.Active, name: '運籌決算' }, { type: TacticType.Active, name: '屠几上肉' }, { type: TacticType.Active, name: '焰逐風飛' }, { type: TacticType.Active, name: '形機軍略' }, { type: TacticType.Active, name: '落鳳' }, { type: TacticType.Active, name: '避實擊虛' }, { type: TacticType.Active, name: '輕勇飛燕' }, { type: TacticType.Active, name: '擊其惰歸' }, { type: TacticType.Active, name: '決水潰城' }, { type: TacticType.Active, name: '絕其汲道' }, { type: TacticType.Active, name: '據水斷橋' }, { type: TacticType.Active, name: '機略縱橫' }, { type: TacticType.Active, name: '見機行事' }, { type: TacticType.Active, name: '聲東擊西' }, { type: TacticType.Active, name: '矢志不移' }, { type: TacticType.Active, name: '黃天泰平' }, { type: TacticType.Active, name: '瞋目橫矛' }, { type: TacticType.Active, name: '料事如神' }, { type: TacticType.Active, name: '落雷' }, { type: TacticType.Active, name: '驍勇善戰' }, { type: TacticType.Active, name: '一力拒守' }, { type: TacticType.Active, name: '守而必固' }, { type: TacticType.Active, name: '唇槍舌戰' }, { type: TacticType.Active, name: '舌戰群儒' }, { type: TacticType.Active, name: '獨行赴斗' }, { type: TacticType.Active, name: '四面楚歌' }, { type: TacticType.Active, name: '沉沙決水' }, { type: TacticType.Active, name: '風聲鶴唳' }, { type: TacticType.Active, name: '萬箭齊發' }, { type: TacticType.Active, name: '所向批靡' }, { type: TacticType.Active, name: '破陣摧堅' }
      ];

      const SOLDIER_BOOK_DATA = {
        '作戰': {
          big: ['蠻勇非勇','一鼓作氣','奇正相生', '勝而益強', '不勇則死'],
          small: ['武略', '勝戰', '執銳', '分險','文韜', '藏刀']
        },
        '虛實': {
          big: ['後發先至','大謀不謀','謀定後動','順應天時', '以治擊亂', '攻其不備'],
          small: ['鬼謀', '妙算', '神機', '將威', '合變','佔卜']
        },
        '軍形': {
          big: ['三裡而還','嚴陣以待', '惜兵愛民', '避其銳氣'],
          small: ['守勢', '靜心', '防備', '鐵甲', '剛柔']
        },
        '九變': {
          big: ['援其必攻','分疾而戰', '臨敵不亂', '無功而勵'],
          small: ['虛掩', '馳援','厲軍', '救主', '百戰', '速戰']
        },
        '始計': {
          big: ['樂善好施','洞若觀火','枕戈坐甲', '三軍之眾', '應機立斷','神清氣淨'],
          small: ['久戰', '銳利', '歸心', '錘鍊','遠謀', '統軍']
        },
        '用間': {
          big: ['審時度勢','出奇制勝', '兵行詭道', '以直報怨','以退為進'],
          small: ['開闔', '持重', '精準', '善戰', '分利']
        }
      };

      const FACTION_COLORS = {
        [Faction.Wei]: 'bg-cyber-panel border-2 border-wei text-wei shadow-[0_0_12px_rgba(0,168,255,0.4)]',
        [Faction.Shu]: 'bg-cyber-panel border-2 border-shu text-shu shadow-[0_0_12px_rgba(0,255,159,0.4)]',
        [Faction.Wu]: 'bg-cyber-panel border-2 border-wu text-wu shadow-[0_0_12px_rgba(255,42,42,0.4)]',
        [Faction.Qun]: 'bg-cyber-panel border-2 border-qun text-qun shadow-[0_0_12px_rgba(252,238,10,0.4)]',
      };

      const TACTIC_COLORS = {
        [TacticType.Command]: 'bg-transparent border border-t_command text-t_command',
        [TacticType.Passive]: 'bg-transparent border border-t_passive text-t_passive',
        [TacticType.Formation]: 'bg-transparent border border-t_formation text-t_formation',
        [TacticType.Assault]: 'bg-transparent border border-t_assault text-t_assault',
        [TacticType.Troop]: 'bg-transparent border border-t_troop text-t_troop',
        [TacticType.Active]: 'bg-transparent border border-t_active text-t_active',
      };

      const STORAGE_KEY = 'tk_builder_stable_vfinal';

      // --- Helper Functions ---
      const createEmptySoldierBook = () => ({
        category: null,
        bigOption: null,
        smallOption1: null,
        smallOption2: null
      });

      const createEmptyGeneral = () => ({
        name: null,
        isCollection: false,
        isDynamic: false,
        redness: 0,
        soldierBook: createEmptySoldierBook()
      });

      const INITIAL_TEAMS = Array.from({ length: 12 }, (_, i) => ({
        id: i,
        generals: [createEmptyGeneral(), createEmptyGeneral(), createEmptyGeneral()],
        tacticsRow1: [null, null, null],
        tacticsRow2: [null, null, null],
      }));

      // --- State ---
      let appState = {
        teams: JSON.parse(JSON.stringify(INITIAL_TEAMS)),
        activePage: 1,
        activeSelection: null, // { teamIndex, type, row, colIndex, currentValue, currentSoldierBook }
        isModalOpen: false,
        
        // Modal internal state
        modal: {
          activeTab: 'All',
          searchTerm: '',
          selectedItems: [],
          sbCategory: '作戰',
          sbBig: null,
          sbSmall: []
        }
      };

      // --- Logic ---
      function loadData() {
        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) {
            const parsed = JSON.parse(saved);
            if (Array.isArray(parsed) && parsed.length === 12) {
               // Migration
               const migrated = parsed.map(team => ({
                ...team,
                generals: team.generals.map((g) => ({
                  ...g,
                  soldierBook: g.soldierBook || createEmptySoldierBook()
                }))
              }));
              appState.teams = migrated;
            }
          }
        } catch (e) {
          console.error("Load data failed", e);
        }
      }

      function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState.teams));
        alert("配將方案已儲存！");
      }

      function resetData() {
        if (confirm("確定重置嗎？")) {
          appState.teams = JSON.parse(JSON.stringify(INITIAL_TEAMS));
          renderApp();
        }
      }

      function setActivePage(page) {
        appState.activePage = page;
        renderApp();
      }

      function openModal(teamIndex, type, row, colIndex, currentValue) {
        const team = appState.teams[teamIndex];
        const currentSoldierBook = type === 'soldierBook' ? team.generals[colIndex].soldierBook : undefined;
        
        appState.activeSelection = { teamIndex, type, row, colIndex, currentValue, currentSoldierBook };
        appState.isModalOpen = true;
        
        // Init modal state
        appState.modal.searchTerm = '';
        appState.modal.selectedItems = currentValue ? [currentValue] : [];
        
        if (type === 'soldierBook') {
           if (currentSoldierBook && currentSoldierBook.category) {
               appState.modal.sbCategory = currentSoldierBook.category;
               appState.modal.sbBig = currentSoldierBook.bigOption;
               appState.modal.sbSmall = [currentSoldierBook.smallOption1, currentSoldierBook.smallOption2].filter(Boolean);
               appState.modal.activeTab = currentSoldierBook.category;
           } else {
               appState.modal.sbCategory = '作戰';
               appState.modal.sbBig = null;
               appState.modal.sbSmall = [];
               appState.modal.activeTab = '作戰';
           }
        } else {
           appState.modal.activeTab = 'All';
        }
        
        // Fix jumping: compensate for scrollbar width
        const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
        document.body.style.paddingRight = scrollbarWidth + 'px';
        document.body.style.overflow = 'hidden';
        
        renderApp();
        
        // Focus search if valid, use preventScroll to avoid jumping
        const searchInput = document.getElementById('modalSearchInput');
        if (searchInput) searchInput.focus({ preventScroll: true });
      }

      function closeModal() {
        appState.isModalOpen = false;
        appState.activeSelection = null;
        
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        renderApp();
      }

      function updateGeneral(teamIndex, colIndex, updates) {
        const g = appState.teams[teamIndex].generals[colIndex];
        Object.assign(g, updates);
        
        // Optimized: Only re-render specific slot instead of full app
        const counts = getCounts();
        const newHtml = renderGeneralSlot(g, appState.teams[teamIndex].id, colIndex, counts.gC, teamIndex);
        
        const el = document.getElementById(`gen-slot-${teamIndex}-${colIndex}`);
        if (el) {
            el.outerHTML = newHtml;
            // Initialize lucide icons for the new content
            if (window.lucide) lucide.createIcons();
        } else {
            renderApp();
        }
      }

      // --- Modal Logic ---
      function handleModalSelect(vals) {
        if (!appState.activeSelection) return;
        
        const { teamIndex, type, row, colIndex } = appState.activeSelection;
        const team = appState.teams[teamIndex];

        if (type === 'soldierBook') {
            team.generals[colIndex].soldierBook = vals || createEmptySoldierBook();
        } else if (row === 'generals') {
            team.generals[colIndex].name = vals ? vals[0] : null;
        } else {
            // Tactics
            const r1 = team.tacticsRow1;
            const r2 = team.tacticsRow2;
            if (!vals) {
                if (row === 'tacticsRow1') r1[colIndex] = null;
                else r2[colIndex] = null;
            } else if (vals.length === 1) {
                if (row === 'tacticsRow1') r1[colIndex] = vals[0];
                else r2[colIndex] = vals[0];
            } else {
                r1[colIndex] = vals[0];
                r2[colIndex] = vals[1] || null;
            }
        }
        closeModal();
      }

      function modalSetTab(tab) {
        appState.modal.activeTab = tab;
        if (appState.activeSelection.type === 'soldierBook') {
            appState.modal.sbCategory = tab;
            appState.modal.sbBig = null;
            appState.modal.sbSmall = [];
        }
        renderApp();
      }
      
      function modalSetSearch(val) {
        appState.modal.searchTerm = val;
        renderApp();
        // Maintain focus is handled by re-rendering carefully or re-focusing
        const el = document.getElementById('modalSearchInput');
        if(el) {
            el.focus({ preventScroll: true });
            el.setSelectionRange(el.value.length, el.value.length);
        }
      }
      
      // Optimized Toggle: Updates DOM directly to avoid re-rendering layout
      function modalToggleItem(name) {
        const { type } = appState.activeSelection;
        if (type === 'general') {
            handleModalSelect([name]);
        } else {
            let prev = appState.modal.selectedItems;
            if (prev.includes(name)) prev = prev.filter(i => i !== name);
            else {
                if (prev.length >= 2) prev = [prev[1], name];
                else prev = [...prev, name];
            }
            appState.modal.selectedItems = prev;
            
            // In-place update to prevent shake
            const buttons = document.querySelectorAll('#modal-grid button');
            buttons.forEach(btn => {
                const btnName = btn.getAttribute('data-name');
                const isSel = prev.includes(btnName);
                const textSpan = btn.querySelector('span');
                
                if (isSel) {
                    btn.classList.remove('border-cyber-border', 'hover:border-white');
                    btn.classList.add('border-cyber-cyan', 'shadow-[0_0_10px_rgba(0,243,255,0.4)]');
                    if(textSpan) {
                        textSpan.classList.remove('text-cyber-dim');
                        textSpan.classList.add('text-cyber-cyan');
                    }
                } else {
                    btn.classList.remove('border-cyber-cyan', 'shadow-[0_0_10px_rgba(0,243,255,0.4)]');
                    btn.classList.add('border-cyber-border', 'hover:border-white');
                    if(textSpan) {
                        textSpan.classList.remove('text-cyber-cyan');
                        textSpan.classList.add('text-cyber-dim');
                    }
                }
            });
            
            const countEl = document.getElementById('modal-buffer-count');
            if (countEl) countEl.innerText = `BUFFER: ${prev.length}/2`;
        }
      }

      function modalConfirm() {
         const { type } = appState.activeSelection;
         if (type === 'soldierBook') {
            const result = {
                category: appState.modal.sbCategory,
                bigOption: appState.modal.sbBig,
                smallOption1: appState.modal.sbSmall[0] || null,
                smallOption2: appState.modal.sbSmall[1] || null
            };
            handleModalSelect(result);
         } else {
            handleModalSelect(appState.modal.selectedItems.length > 0 ? appState.modal.selectedItems : null);
         }
      }

      function modalClear() {
          if (appState.activeSelection.type === 'soldierBook') return;
          handleModalSelect(null);
      }

      // Optimized Soldier Book Toggles
      function modalSetSbBig(opt) {
          appState.modal.sbBig = opt;
          
          const buttons = document.querySelectorAll('[data-sb-big]');
          buttons.forEach(btn => {
              const btnOpt = btn.getAttribute('data-sb-big');
              if (btnOpt === opt) {
                  btn.className = 'py-3 px-2 border text-sm font-bold transition-all bg-cyber-cyan/20 border-cyber-cyan text-cyber-cyan shadow-[0_0_10px_rgba(0,243,255,0.3)]';
              } else {
                  btn.className = 'py-3 px-2 border text-sm font-bold transition-all border-cyber-border text-cyber-dim hover:border-white hover:text-white';
              }
          });
          
          const smallContainer = document.getElementById('sb-small-container');
          if (smallContainer) {
              smallContainer.classList.remove('opacity-30', 'pointer-events-none', 'grayscale');
          }
      }

      function modalToggleSbSmall(opt) {
          let prev = appState.modal.sbSmall;
          if (prev.includes(opt)) prev = prev.filter(i => i !== opt);
          else {
              if (prev.length >= 2) prev = [prev[1], opt];
              else prev = [...prev, opt];
          }
          appState.modal.sbSmall = prev;
          
          const buttons = document.querySelectorAll('[data-sb-small]');
          buttons.forEach(btn => {
              const btnOpt = btn.getAttribute('data-sb-small');
              if (prev.includes(btnOpt)) {
                  btn.className = 'py-2 px-2 border text-xs font-bold transition-all bg-cyber-pink/20 border-cyber-pink text-cyber-pink shadow-[0_0_10px_rgba(255,0,255,0.3)]';
              } else {
                  btn.className = 'py-2 px-2 border text-xs font-bold transition-all border-cyber-border text-cyber-dim hover:border-white hover:text-white';
              }
          });
      }

      // --- Rendering Helpers ---
      
      function getCounts() {
        const gC = {};
        const tC = {};
        appState.teams.forEach(t => {
            t.generals.forEach(g => {
                if (g?.name) {
                    const clean = g.name.split(' ')[0];
                    gC[clean] = (gC[clean] || 0) + 1;
                }
            });
            [...t.tacticsRow1, ...t.tacticsRow2].forEach(tac => {
                if (tac) tC[tac] = (tC[tac] || 0) + 1;
            });
        });
        return { gC, tC };
      }

      function extractCost(name) {
          if (!name) return 0;
          const match = name.match(/\d+$/);
          return match ? parseInt(match[0], 10) : 0;
      }

      // --- HTML Generation ---

      function renderHeader() {
        return `
        <header class="py-4 px-6 sticky top-0 z-20 bg-cyber-bg/90 backdrop-blur-md border-b-2 border-cyber-cyan shadow-[0_0_15px_rgba(0,243,255,0.2)] mb-8 clip-path-header">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <i data-lucide="cpu" width="32" height="32" class="text-cyber-cyan animate-pulse-fast"></i>
                <div>
                <h1 class="text-2xl font-black text-cyber-cyan tracking-tighter uppercase leading-none drop-shadow-[0_0_5px_rgba(0,243,255,0.8)]">
                    配將模擬器
                </h1>
                <div class="flex gap-2 text-[10px] uppercase font-bold tracking-widest leading-none mt-1">
                    <span class="text-cyber-dim">System: Online</span>
                    <span class="text-cyber-red animate-pulse">Q喝杯茶做的</span>
                </div>
                </div>
            </div>
            
            <div class="flex flex-row items-center gap-4">
                <div class="flex p-1 bg-black/50 border border-cyber-dim rounded-none skew-x-[-10deg]">
                <button 
                    onclick="setActivePage(1)" 
                    class="skew-x-[10deg] px-6 py-1.5 text-xs font-bold transition-all uppercase tracking-wider ${appState.activePage === 1 ? 'bg-cyber-cyan text-black shadow-[0_0_10px_rgba(0,243,255,0.6)]' : 'text-cyber-dim hover:text-white'}"
                >
                    Units 1-6
                </button>
                <button 
                    onclick="setActivePage(2)" 
                    class="skew-x-[10deg] px-6 py-1.5 text-xs font-bold transition-all uppercase tracking-wider ${appState.activePage === 2 ? 'bg-cyber-cyan text-black shadow-[0_0_10px_rgba(0,243,255,0.6)]' : 'text-cyber-dim hover:text-white'}"
                >
                    Units 7-12
                </button>
                </div>
                <div class="flex gap-3">
                <button onclick="saveData()" class="cyber-btn bg-cyber-card border border-cyber-cyan text-cyber-cyan px-5 py-2 hover:bg-cyber-cyan hover:text-black flex items-center gap-2 font-bold text-xs uppercase tracking-widest shadow-[0_0_5px_rgba(0,243,255,0.3)]">
                    <i data-lucide="save" width="14" height="14"></i> Save
                </button>
                <button onclick="resetData()" class="cyber-btn bg-cyber-card border border-cyber-red text-cyber-red px-3 py-2 hover:bg-cyber-red hover:text-black flex items-center gap-2 font-bold text-xs uppercase tracking-widest shadow-[0_0_5px_rgba(255,42,42,0.3)]">
                    <i data-lucide="rotate-ccw" width="14" height="14"></i>
                </button>
                </div>
            </div>
            </div>
        </header>`;
      }

      function renderTeamCard(team, index, counts) {
          const totalCost = team.generals.reduce((sum, g) => sum + extractCost(g.name), 0);
          const totalRed = team.generals.reduce((sum, g) => sum + g.redness, 0);
          
          let generalsHtml = '';
          team.generals.forEach((g, i) => {
              generalsHtml += renderGeneralSlot(g, team.id, i, counts.gC, index); // index passed for callbacks
          });

          let tacticsRow1Html = team.tacticsRow1.map((tac, i) => renderTacticSlot(tac, team.id, 'tacticsRow1', i, counts.tC, index)).join('');
          let tacticsRow2Html = team.tacticsRow2.map((tac, i) => renderTacticSlot(tac, team.id, 'tacticsRow2', i, counts.tC, index)).join('');
          
          let soldierBookHtml = team.generals.map((g, i) => renderSoldierBookSlot(g, team.id, i, index)).join('');

          return `
            <div class="cyber-card p-5 group transition-all hover:border-cyber-cyan/60 animate-slide-up" style="animation-delay: ${(index % 6) * 0.1}s">
                <div class="absolute top-0 left-0 w-2 h-2 border-t-2 border-l-2 border-cyber-cyan"></div>
                <div class="absolute top-0 right-0 w-2 h-2 border-t-2 border-r-2 border-cyber-cyan"></div>
                <div class="absolute bottom-0 left-0 w-2 h-2 border-b-2 border-l-2 border-cyber-cyan"></div>
                <div class="absolute bottom-0 right-0 w-2 h-2 border-b-2 border-r-2 border-cyber-cyan"></div>

                <div class="flex items-center justify-between mb-6 border-b border-cyber-border pb-2">
                    <div class="flex flex-col">
                    <h2 class="text-cyber-cyan font-black text-xl tracking-tighter drop-shadow-[0_0_2px_#00f3ff]">SQUAD ${index + 1}</h2>
                    <div class="h-1 w-12 bg-cyber-pink mt-1 shadow-[0_0_5px_#ff00ff]"></div>
                    </div>
                    <div class="flex gap-2 font-mono text-[10px]">
                    <div class="bg-black border border-cyber-cyan px-2 py-1 text-cyber-cyan flex items-center gap-1">
                        COST <span class="text-sm font-bold">${totalCost}</span>
                    </div>
                    <div class="bg-black border border-cyber-red px-2 py-1 text-cyber-red flex items-center gap-1">
                        RED <span class="text-sm font-bold">${totalRed}</span>
                    </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    ${generalsHtml}
                    <div class="col-span-3 grid grid-cols-3 gap-2 mt-3 pt-3 border-t border-cyber-border">
                        ${tacticsRow1Html}
                        ${tacticsRow2Html}
                    </div>
                    <div class="col-span-3 grid grid-cols-3 gap-2 mt-1">
                        ${soldierBookHtml}
                    </div>
                </div>
            </div>
          `;
      }

      function renderGeneralSlot(g, teamId, colIndex, gCounts, flatTeamIndex) {
          const cost = extractCost(g.name);
          let styleClass = '';
          
          if (!g.name) {
              styleClass = 'bg-black/60 border-2 border-dashed border-cyber-dim text-cyber-dim hover:border-cyber-cyan hover:text-cyber-cyan hover:shadow-neon-cyan';
          } else {
              const cleanName = g.name.split(' ')[0];
              const generalData = GENERALS_DATA.find(x => x.name.startsWith(cleanName));
              const isDup = gCounts[cleanName] > 1;
              let baseStyle = generalData ? FACTION_COLORS[generalData.faction] : 'bg-gray-800 text-white';
              
              if (g.isDynamic) baseStyle = `bg-black border-2 border-cyber-yellow text-cyber-yellow shadow-neon-yellow animate-pulse-fast`;
              else if (isDup) baseStyle = `bg-black border-2 border-cyber-red text-cyber-red shadow-neon-red animate-glitch`;
              
              styleClass = baseStyle;
          }

          const buttonContent = g.name ? `
             <div class="absolute top-1 left-1 bg-black border border-current text-[9px] px-1 font-mono">C${cost}</div>
             <span class="text-2xl tracking-tighter text-center leading-none z-10">${g.name.split(' ')[0]}</span>
             <div class="absolute inset-0 bg-[linear-gradient(rgba(0,0,0,0.1)_1px,transparent_1px),linear-gradient(90deg,rgba(0,0,0,0.1)_1px,transparent_1px)] bg-[size:4px_4px] opacity-20 pointer-events-none"></div>
          ` : `
             <div class="flex flex-col items-center gap-1 opacity-50">
                <i data-lucide="plus" width="20" height="20"></i>
                <span class="text-[9px] tracking-widest uppercase">Empty</span>
             </div>
          `;

          // Redness Stars
          let starsHtml = '';
          if (g.name) {
              starsHtml = '<div class="flex gap-0.5 justify-center py-1">';
              for (let s = 1; s <= 5; s++) {
                  const fillClass = s <= g.redness ? 'fill-cyber-red text-cyber-red drop-shadow-[0_0_3px_#ff2a2a]' : 'fill-cyber-dim/20 text-cyber-dim hover:text-cyber-red';
                  starsHtml += `<button onclick="updateGeneral(${flatTeamIndex}, ${colIndex}, { redness: ${g.redness === s ? 0 : s} })" class="focus:outline-none transition-transform active:scale-90"><i data-lucide="star" width="10" height="10" class="transition-colors ${fillClass}"></i></button>`;
              }
              starsHtml += '</div>';
          }

          const controls = g.name ? `
            <div class="flex flex-col gap-1.5 px-0.5 mt-1">
                <div class="flex gap-1 justify-center">
                  <button 
                    onclick="updateGeneral(${flatTeamIndex}, ${colIndex}, { isCollection: ${!g.isCollection} })"
                    class="w-6 h-6 border flex items-center justify-center transition-all ${g.isCollection ? 'bg-cyber-yellow text-black border-cyber-yellow shadow-neon-yellow' : 'bg-black text-cyber-dim border-cyber-border hover:border-white'}"
                    title="典藏"
                  >
                    <i data-lucide="disc" width="12" height="12"></i>
                  </button>
                  <button 
                    onclick="updateGeneral(${flatTeamIndex}, ${colIndex}, { isDynamic: ${!g.isDynamic} })"
                    class="w-6 h-6 border flex items-center justify-center transition-all ${g.isDynamic ? 'bg-cyber-pink text-black border-cyber-pink shadow-neon-pink' : 'bg-black text-cyber-dim border-cyber-border hover:border-white'}"
                    title="動態"
                  >
                    <i data-lucide="activity" width="12" height="12"></i>
                  </button>
                </div>
                ${starsHtml}
            </div>
          ` : '';

          return `
            <div id="gen-slot-${flatTeamIndex}-${colIndex}" class="flex flex-col gap-2">
                <button 
                    onclick="openModal(${flatTeamIndex}, 'general', 'generals', ${colIndex}, '${g.name || ''}')"
                    class="relative w-full aspect-[4/5] clip-path-polygon flex flex-col items-center justify-center font-black transition-all active:scale-95 ${styleClass}"
                    style="clip-path: polygon(15% 0, 100% 0, 100% 85%, 85% 100%, 0 100%, 0 15%)"
                >
                    ${buttonContent}
                </button>
                ${controls}
            </div>
          `;
      }

      function renderTacticSlot(name, teamId, rowName, colIndex, tCounts, flatTeamIndex) {
          let styleClass = '';
          if (!name) {
              styleClass = 'bg-black/50 border border-dashed border-cyber-dim text-cyber-dim hover:border-cyber-text hover:text-white';
          } else {
              const t = TACTICS_DATA.find(x => x.name === name);
              const isDup = tCounts[name] > 1;
              const baseColor = t ? TACTIC_COLORS[t.type] : 'bg-gray-800 text-white';
              styleClass = `${baseColor} shadow-[0_0_5px_rgba(0,0,0,0.8)]`;
              if (isDup) styleClass += ' border-cyber-red border-2 text-cyber-red animate-pulse';
          }

          const clipPath = rowName === 'tacticsRow1' 
            ? 'polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px)'
            : 'polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%)';

          return `
            <button 
                onclick="openModal(${flatTeamIndex}, 'tactic', '${rowName}', ${colIndex}, '${name || ''}')"
                class="w-full h-10 flex items-center justify-center text-sm font-bold transition-all active:scale-95 px-1 text-center leading-none tracking-tight ${styleClass} clip-path-btn"
                style="clip-path: ${clipPath}"
            >
                ${name ? `<span>${name}</span>` : `<i data-lucide="plus" width="14" height="14" class="opacity-20"></i>`}
            </button>
          `;
      }

      function renderSoldierBookSlot(g, teamId, colIndex, flatTeamIndex) {
          const sb = g.soldierBook;
          const hasContent = sb && sb.category;
          
          let styleClass = hasContent 
            ? 'bg-cyber-panel border-cyber-pink text-cyber-text'
            : 'bg-black/40 border-cyber-dim text-cyber-dim hover:border-white';
            
          let content = '';
          if (hasContent) {
              content = `
                 <div class="flex flex-col gap-0.5 w-full">
                   <div class="text-cyber-pink font-black text-sm">${sb.category}</div>
                   ${sb.bigOption ? `<div class="text-cyber-cyan text-xs truncate">${sb.bigOption}</div>` : ''}
                   <div class="flex justify-center gap-1 text-[11px] text-cyber-dim opacity-100">
                      ${sb.smallOption1 ? `<span>${sb.smallOption1}</span>` : ''}
                      ${sb.smallOption2 ? `<span>${sb.smallOption2}</span>` : ''}
                   </div>
                 </div>
              `;
          } else {
              content = `
                <div class="opacity-60 flex flex-col items-center">
                   <span>兵書</span>
                </div>
              `;
          }

          return `
            <button 
              onclick="openModal(${flatTeamIndex}, 'soldierBook', 'generals', ${colIndex}, null)"
              class="w-full flex flex-col items-center justify-center text-[9px] font-bold transition-all active:scale-95 py-1.5 px-0.5 text-center leading-none tracking-tight clip-path-btn border ${styleClass}"
              style="clip-path: polygon(0 0, 100% 0, 100% 100%, 10px 100%, 0 calc(100% - 10px))"
            >
              ${content}
            </button>
          `;
      }

      function renderModal() {
        if (!appState.isModalOpen) return '';
        
        const { type } = appState.activeSelection;
        const { activeTab, searchTerm, selectedItems, sbCategory, sbBig, sbSmall } = appState.modal;

        // Tabs
        let tabs = [];
        if (type === 'general') tabs = ['All', ...Object.values(Faction)];
        else if (type === 'tactic') tabs = ['All', ...Object.values(TacticType)];
        else tabs = Object.keys(SOLDIER_BOOK_DATA);

        let tabsHtml = tabs.map(tab => `
            <button 
                onclick="modalSetTab('${tab}')" 
                class="px-4 py-2 text-xs font-bold transition-all whitespace-nowrap uppercase tracking-wider border clip-path-btn ${activeTab === tab ? 'bg-cyber-cyan text-black border-cyber-cyan' : 'bg-transparent text-cyber-dim border-cyber-border hover:border-white hover:text-white'}"
                style="clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px)"
            >
                ${tab === 'All' ? 'ALL_DATA' : tab}
            </button>
        `).join('');
        
        // Soldier Book Tabs override styling slightly
        if (type === 'soldierBook') {
             tabsHtml = tabs.map(tab => `
                <button 
                    onclick="modalSetTab('${tab}')" 
                    class="px-4 py-2 text-xs font-bold transition-all whitespace-nowrap uppercase tracking-wider border clip-path-btn ${sbCategory === tab ? 'bg-cyber-yellow text-black border-cyber-yellow shadow-neon-yellow' : 'bg-transparent text-cyber-dim border-cyber-border hover:text-white hover:border-white'}"
                    style="clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px)"
                >
                    ${tab}
                </button>
            `).join('');
        }

        let contentHtml = '';

        if (type === 'soldierBook') {
            const data = SOLDIER_BOOK_DATA[sbCategory];
            if (data) {
                const bigBtns = data.big.map(opt => `
                    <button 
                        data-sb-big="${opt}"
                        onclick="modalSetSbBig('${opt}')"
                        class="py-3 px-2 border text-sm font-bold transition-all ${sbBig === opt ? 'bg-cyber-cyan/20 border-cyber-cyan text-cyber-cyan shadow-[0_0_10px_rgba(0,243,255,0.3)]' : 'border-cyber-border text-cyber-dim hover:border-white hover:text-white'}"
                    >
                        ${opt}
                    </button>
                `).join('');

                const smallBtns = data.small.map(opt => `
                    <button 
                        data-sb-small="${opt}"
                        onclick="modalToggleSbSmall('${opt}')"
                        class="py-2 px-2 border text-xs font-bold transition-all ${sbSmall.includes(opt) ? 'bg-cyber-pink/20 border-cyber-pink text-cyber-pink shadow-[0_0_10px_rgba(255,0,255,0.3)]' : 'border-cyber-border text-cyber-dim hover:border-white hover:text-white'}"
                    >
                        ${opt}
                    </button>
                `).join('');

                contentHtml = `
                    <div class="flex flex-col h-full overflow-hidden" id="modal-content-scroll">
                        <div class="p-4 bg-black/40 border-b border-cyber-border flex gap-2 overflow-x-auto no-scrollbar">${tabsHtml}</div>
                        <div class="flex-1 overflow-y-auto p-6 bg-[linear-gradient(rgba(0,243,255,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(0,243,255,0.03)_1px,transparent_1px)] bg-[size:20px_20px] space-y-6">
                            <div>
                                <h4 class="text-cyber-cyan font-bold mb-3 border-l-4 border-cyber-cyan pl-2">核心 (BIG) <span class="text-xs text-cyber-dim ml-2">Select 1</span></h4>
                                <div class="grid grid-cols-3 gap-4">${bigBtns}</div>
                            </div>
                            <div id="sb-small-container" class="${!sbBig ? 'opacity-30 pointer-events-none grayscale' : ''}">
                                <h4 class="text-cyber-pink font-bold mb-3 border-l-4 border-cyber-pink pl-2">進階 (SMALL) <span class="text-xs text-cyber-dim ml-2">Select 2</span></h4>
                                <div class="grid grid-cols-3 sm:grid-cols-4 gap-3">${smallBtns}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        } else {
            // General or Tactic Items
            let items = [];
            if (type === 'general') {
                items = GENERALS_DATA.map(g => ({ name: g.name, category: g.faction, color: FACTION_COLORS[g.faction] }));
            } else {
                items = TACTICS_DATA.map(t => ({ name: t.name, category: t.type, color: TACTIC_COLORS[t.type] }));
            }
            
            // Filter
            if (activeTab !== 'All') items = items.filter(i => i.category === activeTab);
            if (searchTerm) items = items.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase()));

            const gridHtml = items.map((item, idx) => {
                const isSelected = selectedItems.includes(item.name);
                const colorClass = item.color.replace('border-2', 'border').replace(/shadow-\[.*?\]/g, ''); // strip complex shadow from CSS string for simplified rendering
                
                return `
                    <button 
                        data-name="${item.name}"
                        onclick="modalToggleItem('${item.name}')" 
                        class="group flex flex-col items-center p-2 bg-black/60 border transition-all active:scale-95 hover:shadow-[0_0_10px_rgba(255,255,255,0.2)] ${isSelected ? 'border-cyber-cyan shadow-[0_0_10px_rgba(0,243,255,0.4)]' : 'border-cyber-border hover:border-white'}"
                    >
                        <div class="w-full aspect-square mb-2 flex items-center justify-center font-black text-xs text-center leading-tight p-1 ${colorClass} bg-opacity-20">
                            ${item.name.split(' ')[0]}
                        </div>
                        <span class="text-[10px] font-bold truncate w-full text-center font-mono group-hover:text-white ${isSelected ? 'text-cyber-cyan' : 'text-cyber-dim'}">${item.name}</span>
                    </button>
                `;
            }).join('');

            contentHtml = `
                <div class="p-4 bg-black/40 border-b border-cyber-border space-y-3">
                    <div class="relative group">
                        <i data-lucide="search" width="16" height="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-cyber-dim group-hover:text-cyber-cyan transition-colors"></i>
                        <input id="modalSearchInput" type="text" placeholder="SEARCH_DATABASE..." class="w-full pl-10 pr-4 py-2 bg-black border border-cyber-border text-cyber-text font-mono text-sm focus:border-cyber-cyan focus:shadow-[0_0_10px_rgba(0,243,255,0.3)] outline-none transition-all placeholder:text-cyber-dim" value="${searchTerm}" oninput="modalSetSearch(this.value)" />
                    </div>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                        ${tabsHtml}
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-4 bg-[linear-gradient(rgba(0,243,255,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(0,243,255,0.03)_1px,transparent_1px)] bg-[size:20px_20px]" id="modal-content-scroll">
                    <div id="modal-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                        ${gridHtml}
                    </div>
                </div>
            `;
        }

        return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-0 sm:p-4">
                <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal()"></div>
                <div class="relative w-full max-w-2xl bg-cyber-bg border border-cyber-cyan shadow-[0_0_30px_rgba(0,243,255,0.2)] flex flex-col max-h-[90vh] animate-slide-up overflow-hidden clip-path-btn" style="clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px)">
                    <div class="px-4 py-3 bg-cyber-panel border-b border-cyber-border flex items-center justify-between shrink-0">
                        <div class="flex items-center gap-3">
                            <i data-lucide="${type === 'soldierBook' ? 'book-open' : 'terminal'}" width="18" height="18" class="${type === 'soldierBook' ? 'text-cyber-yellow' : 'text-cyber-pink'}"></i>
                            <h3 class="text-lg font-bold text-cyber-text tracking-widest uppercase">
                                SELECT // <span class="text-cyber-cyan">${type === 'general' ? 'WARLORD' : type === 'tactic' ? 'TACTIC' : 'SOLDIER BOOK'}</span>
                            </h3>
                            ${type === 'tactic' ? `
                                <span id="modal-buffer-count" class="bg-cyber-cyan/20 text-cyber-cyan border border-cyber-cyan px-2 py-0.5 text-[10px] font-bold">
                                    BUFFER: ${selectedItems.length}/2
                                </span>
                            ` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            ${(type === 'tactic' || type === 'soldierBook') ? `
                                <button onclick="modalConfirm()" class="p-1.5 bg-cyber-cyan text-black hover:bg-white transition-colors shadow-[0_0_10px_#00f3ff]">
                                    <i data-lucide="check" width="18" height="18"></i>
                                </button>
                            ` : ''}
                            <button onclick="closeModal()" class="p-1.5 bg-transparent border border-cyber-red text-cyber-red hover:bg-cyber-red hover:text-black transition-colors">
                                <i data-lucide="x" width="18" height="18"></i>
                            </button>
                        </div>
                    </div>
                    ${contentHtml}
                </div>
            </div>
        `;
      }

      function renderApp() {
        // Capture scroll positions and focus
        const scrollTop = window.scrollY;
        const modalScroll = document.getElementById('modal-content-scroll');
        const modalScrollTop = modalScroll ? modalScroll.scrollTop : 0;
        
        const activeSearch = document.activeElement && document.activeElement.id === 'modalSearchInput';
        const searchSelectionStart = activeSearch ? document.getElementById('modalSearchInput').selectionStart : 0;
        const searchSelectionEnd = activeSearch ? document.getElementById('modalSearchInput').selectionEnd : 0;

        const counts = getCounts();
        
        // Get active teams based on page
        const startIdx = (appState.activePage - 1) * 6;
        const currentTeams = appState.teams.slice(startIdx, startIdx + 6);
        
        let teamsHtml = currentTeams.map((team, idx) => renderTeamCard(team, startIdx + idx, counts)).join('');

        const html = `
           ${renderHeader()}
           <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-4">
              ${teamsHtml}
           </main>
           ${renderModal()}
        `;

        document.getElementById('app').innerHTML = html;
        
        // Restore scroll positions
        window.scrollTo(0, scrollTop);
        const newModalScroll = document.getElementById('modal-content-scroll');
        if (newModalScroll) newModalScroll.scrollTop = modalScrollTop;
        
        // Restore focus
        if (activeSearch) {
            const input = document.getElementById('modalSearchInput');
            if (input) {
                input.focus({ preventScroll: true });
                input.setSelectionRange(searchSelectionStart, searchSelectionEnd);
            }
        }
        
        // Re-initialize icons
        if (window.lucide) {
            lucide.createIcons();
        }
      }

      // --- Initialization ---
      window.onload = function() {
        loadData();
        renderApp();
      };
    </script>
</body>
</html>
