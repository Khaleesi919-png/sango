<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>三國志戰略版配將模擬器</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              wei: '#2e58a6', // 魏國藍
              shu: '#3b8c4d', // 蜀國綠
              wu: '#c23c3c',  // 吳國紅
              qun: '#d4a017', // 群雄金
              t_command: '#78808A',
              t_passive: '#9F8AC7',
              t_formation: '#C4A274',
              t_assault: '#C4788A',
              t_troop: '#6CA693',
              t_active: '#729DB3',
            }
          }
        }
      }
    </script>
    
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #F2F2F7;
      }
      .ios-card {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      @keyframes slide-up {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
      }
      .animate-slide-up {
        animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
    </style>

    <!-- React 18 & Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.561.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo, useEffect, useCallback } = React;

      // --- 定義 ---
      const Faction = { Wei: '魏', Shu: '蜀', Wu: '吳', Qun: '群' };
      const TacticType = { 
        Command: '指揮戰法', Passive: '被動戰法', Formation: '陣法', 
        Assault: '突擊戰法', Troop: '兵種', Active: '主動戰法' 
      };
      const STORAGE_KEY = 'three_kingdoms_persistent_v3';

      // --- 圖示組件 ---
      const Icon = ({ name, size = 20, className = "" }) => {
        const paths = {
          plus: <path d="M5 12h14M12 5v14"/>,
          star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>,
          x: <path d="M18 6 6 18M6 6 12 12"/>,
          search: <><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>,
          trash: <><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
          share: <><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></>,
          save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>,
          rotate: <><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>,
          check: <polyline points="20 6 9 17 4 12"/>
        };
        return (
          <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            {paths[name]}
          </svg>
        );
      };

      // --- 資料庫 ---
      const GENERALS_DATA = [
        { faction: Faction.Shu, name: '劉備 7' }, { faction: Faction.Shu, name: '龐統 7' }, { faction: Faction.Shu, name: '諸葛亮 7' }, { faction: Faction.Shu, name: 'SP諸葛亮 6' }, { faction: Faction.Shu, name: '關羽 7' }, { faction: Faction.Shu, name: 'SP關羽 7' }, { faction: Faction.Shu, name: 'SP黃月英 4' }, { faction: Faction.Shu, name: '黃忠 6' }, { faction: Faction.Shu, name: 'SP黃忠 6' }, { faction: Faction.Shu, name: '趙雲 6' }, { faction: Faction.Shu, name: '張飛 6' }, { faction: Faction.Shu, name: '姜維 6' }, { faction: Faction.Shu, name: '關銀屏 6' }, { faction: Faction.Shu, name: '魏延 6' }, { faction: Faction.Shu, name: '張苞 6' }, { faction: Faction.Shu, name: '關興 6' }, { faction: Faction.Shu, name: 'SP法正 6' }, { faction: Faction.Shu, name: '法正 4' }, { faction: Faction.Shu, name: '王平 5' }, { faction: Faction.Shu, name: '徐庶 5' }, { faction: Faction.Shu, name: '黃月英 4' }, { faction: Faction.Shu, name: '馬超 7' }, { faction: Faction.Shu, name: '馬雲祿 5' }, { faction: Faction.Shu, name: '陳到 6' }, { faction: Faction.Shu, name: '嚴顏 6' }, { faction: Faction.Shu, name: '伊籍 6' },
        { faction: Faction.Qun, name: 'SP馬超 7' }, { faction: Faction.Qun, name: 'SP皇甫嵩 6' }, { faction: Faction.Qun, name: 'SP袁紹 7' }, { faction: Faction.Qun, name: 'SP朱儁 6' }, { faction: Faction.Qun, name: '沮授 6' }, { faction: Faction.Qun, name: '貂蟬 4' }, { faction: Faction.Qun, name: 'SP貂蟬 6' }, { faction: Faction.Qun, name: '許攸 6' }, { faction: Faction.Qun, name: '呂布 7' }, { faction: Faction.Qun, name: '袁術 6' }, { faction: Faction.Qun, name: '公孫瓚 6' }, { faction: Faction.Qun, name: '張角 6' }, { faction: Faction.Qun, name: '于吉 7' }, { faction: Faction.Qun, name: '華佗 5' }, { faction: Faction.Qun, name: '左慈 5' }, { faction: Faction.Qun, name: '董卓 7' }, { faction: Faction.Qun, name: 'SP董卓 7' }, { faction: Faction.Qun, name: '孟獲 7' }, { faction: Faction.Qun, name: '呂玲綺 6' }, { faction: Faction.Qun, name: '祝融夫人 6' }, { faction: Faction.Qun, name: '兀突骨 6' }, { faction: Faction.Qun, name: '袁紹 6' }, { faction: Faction.Qun, name: '麴義 6' }, { faction: Faction.Qun, name: '朵思大王 6' }, { faction: Faction.Qun, name: '木鹿大王 6' }, { faction: Faction.Qun, name: '張讓 5' }, { faction: Faction.Qun, name: '李儒 5' }, { faction: Faction.Qun, name: '高順 5' }, { faction: Faction.Qun, name: '馬騰 5' }, { faction: Faction.Qun, name: '文醜 5' }, { faction: Faction.Qun, name: '華雄 5' }, { faction: Faction.Qun, name: '顏良 5' }, { faction: Faction.Qun, name: '高覽 5' }, { faction: Faction.Qun, name: '陳宮 5' }, { faction: Faction.Qun, name: '蔡文姬 3' }, { faction: Faction.Qun, name: '董白 3' }, { faction: Faction.Qun, name: 'SP張寶 6' }, { faction: Faction.Qun, name: 'SP張梁 5' }, { faction: Faction.Qun, name: '田豐 6' }, { faction: Faction.Qun, name: '鄒氏 3' },
        { faction: Faction.Wu, name: '孫尚香 6' }, { faction: Faction.Wu, name: '周泰 6' }, { faction: Faction.Wu, name: '凌統 6' }, { faction: Faction.Wu, name: '陸遜 7' }, { faction: Faction.Wu, name: '魯肅 6' }, { faction: Faction.Wu, name: '周瑜 6' }, { faction: Faction.Wu, name: 'SP周瑜 6' }, { faction: Faction.Wu, name: '孫權 6' }, { faction: Faction.Wu, name: '呂蒙 6' }, { faction: Faction.Wu, name: 'SP呂蒙 7' }, { faction: Faction.Wu, name: '太史慈 6' }, { faction: Faction.Wu, name: '孫堅 6' }, { faction: Faction.Wu, name: 'SP孫堅 7' }, { faction: Faction.Wu, name: '甘寧 6' }, { faction: Faction.Wu, name: '程普 5' }, { faction: Faction.Wu, name: '陸抗 6' }, { faction: Faction.Wu, name: '黃蓋 5' }, { faction: Faction.Wu, name: '諸葛格 4' }, { faction: Faction.Wu, name: '孫策 5' },
        { faction: Faction.Wei, name: '司馬懿 7' }, { faction: Faction.Wei, name: '曹操 7' }, { faction: Faction.Wei, name: '滿寵 5' }, { faction: Faction.Wei, name: '典韋 6' }, { faction: Faction.Wei, name: 'SP典韋 6' }, { faction: Faction.Wei, name: '賈詡 7' }, { faction: Faction.Wei, name: 'SP荀彧 7' }, { faction: Faction.Wei, name: 'SP郭嘉 6' }, { faction: Faction.Wei, name: '荀攸 6' }, { faction: Faction.Wei, name: '張遼 7' }, { faction: Faction.Wei, name: '王元姬 5' }, { faction: Faction.Wei, name: '郭嘉 5' }, { faction: Faction.Wei, name: '王異 6' }, { faction: Faction.Wei, name: '龐德 5' }, { faction: Faction.Wei, name: 'SP龐德 6' }, { faction: Faction.Wei, name: '郝昭 5' }, { faction: Faction.Wei, name: '曹仁 6' }, { faction: Faction.Wei, name: '程昱 5' }, { faction: Faction.Wei, name: '許褚 6' }, { faction: Faction.Wei, name: '張郃 6' }, { faction: Faction.Wei, name: '徐晃 6' }, { faction: Faction.Wei, name: '夏侯惇 6' }, { faction: Faction.Wei, name: '鍾會 6' }, { faction: Faction.Wei, name: '王雙 5' }, { faction: Faction.Wei, name: '曹純 5' }, { faction: Faction.Wei, name: '于禁 5' }, { faction: Faction.Wei, name: '樂進 5' }, { faction: Faction.Wei, name: '鄧艾 5' }, { faction: Faction.Wei, name: '夏侯淵 5' }, { faction: Faction.Wei, name: '張春華 3' }, { faction: Faction.Wei, name: 'SP劉曄 6' }, { faction: Faction.Wei, name: 'SP曹真 6' }
      ];

      const TACTICS_DATA = [
        { type: TacticType.Command, name: '虛實奇謀' }, { type: TacticType.Command, name: '深謀遠慮' }, { type: TacticType.Command, name: '蓄勢待發' }, { type: TacticType.Command, name: '暫避其鋒' }, { type: TacticType.Command, name: '盛氣淩敵' }, { type: TacticType.Command, name: '用武神通' }, { type: TacticType.Command, name: '夢中弒臣' }, { type: TacticType.Command, name: '挫銳' }, { type: TacticType.Command, name: '非攻制勝' }, { type: TacticType.Command, name: '鐵騎驅馳' }, { type: TacticType.Command, name: '撫輯軍民' }, { type: TacticType.Command, name: '禦敵屏障' }, { type: TacticType.Command, name: '整裝待發' }, { type: TacticType.Command, name: '眾志成城' },
        { type: TacticType.Passive, name: '功不唐捐' }, { type: TacticType.Passive, name: '千里走單騎' }, { type: TacticType.Passive, name: '魅惑' }, { type: TacticType.Passive, name: '忠勇益烈' }, { type: TacticType.Passive, name: '文武雙全' }, { type: TacticType.Passive, name: '士爭先赴' }, { type: TacticType.Passive, name: '裸衣血戰' }, { type: TacticType.Passive, name: '太平道法' }, { type: TacticType.Passive, name: '兵無常勢' }, { type: TacticType.Passive, name: '士別三日' },
        { type: TacticType.Formation, name: '潛龍陣' }, { type: TacticType.Formation, name: '鋒矢陣' }, { type: TacticType.Formation, name: '八門金鎖陣' }, { type: TacticType.Formation, name: '箕形陣' }, { type: TacticType.Formation, name: '三勢陣' }, { type: TacticType.Formation, name: '行一陣' }, { type: TacticType.Formation, name: '武鋒陣' },
        { type: TacticType.Assault, name: '摧鋒斷刃' }, { type: TacticType.Assault, name: '折衝禦侮' }, { type: TacticType.Assault, name: '暴戾無仁' }, { type: TacticType.Assault, name: '一騎當千' }, { type: TacticType.Assault, name: '百騎劫營' }, { type: TacticType.Assault, name: '當鋒摧決' }, { type: TacticType.Assault, name: '速乘其利' },
        { type: TacticType.Troop, name: '虎豹騎' }, { type: TacticType.Troop, name: '藤甲兵' }, { type: TacticType.Troop, name: '白馬義從' }, { type: TacticType.Troop, name: '陷陣營' }, { type: TacticType.Troop, name: '西涼鐵騎' }, { type: TacticType.Troop, name: '青州兵' }, { type: TacticType.Troop, name: '無當飛軍' },
        { type: TacticType.Active, name: '偽書相間' }, { type: TacticType.Active, name: '奪魂挾魄' }, { type: TacticType.Active, name: '草船借箭' }, { type: TacticType.Active, name: '刮骨療傷' }, { type: TacticType.Active, name: '威謀靡亢' }, { type: TacticType.Active, name: '臨機制勝' }, { type: TacticType.Active, name: '破軍威勝' }, { type: TacticType.Active, name: '橫掃千軍' }, { type: TacticType.Active, name: '萬箭齊發' }, { type: TacticType.Active, name: '所向批靡' }, { type: TacticType.Active, name: '破陣摧堅' }
      ];

      const FACTION_COLORS = { [Faction.Wei]: 'bg-wei', [Faction.Shu]: 'bg-shu', [Faction.Wu]: 'bg-wu', [Faction.Qun]: 'bg-qun' };
      const TACTIC_COLORS = { 
        [TacticType.Command]: 'bg-t_command', [TacticType.Passive]: 'bg-t_passive', [TacticType.Formation]: 'bg-t_formation', 
        [TacticType.Assault]: 'bg-t_assault', [TacticType.Troop]: 'bg-t_troop', [TacticType.Active]: 'bg-t_active' 
      };

      // --- 工具函數 ---
      const extractCost = (name) => {
        if (!name) return 0;
        const match = name.match(/\d+$/);
        return match ? parseInt(match[0], 10) : 0;
      };

      // --- 子組件: 選擇彈窗 ---
      const SelectionModal = ({ isOpen, type, onClose, onSelect }) => {
        const [activeTab, setActiveTab] = useState('All');
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedItems, setSelectedItems] = useState([]);

        const tabs = useMemo(() => type === 'general' ? ['All', ...Object.values(Faction)] : ['All', ...Object.values(TacticType)], [type]);
        
        const filteredItems = useMemo(() => {
          let items = type === 'general' 
            ? GENERALS_DATA.map(g => ({ name: g.name, category: g.faction, color: FACTION_COLORS[g.faction] }))
            : TACTICS_DATA.map(t => ({ name: t.name, category: t.type, color: TACTIC_COLORS[t.type] }));
          if (activeTab !== 'All') items = items.filter(i => i.category === activeTab);
          if (searchTerm) items = items.filter(i => i.name.includes(searchTerm));
          return items;
        }, [type, activeTab, searchTerm]);

        const toggleItem = (name) => {
          if (type === 'general') { onSelect([name]); return; }
          setSelectedItems(prev => {
            if (prev.includes(name)) return prev.filter(i => i !== name);
            if (prev.length >= 2) return [prev[1], name];
            return [...prev, name];
          });
        };

        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onClose} />
            <div className="relative w-full max-w-2xl bg-white sm:rounded-2xl rounded-t-2xl shadow-2xl flex flex-col max-h-[90vh] animate-slide-up">
              <div className="px-4 py-3 border-b flex items-center justify-between bg-white shrink-0">
                <div className="flex items-center gap-3">
                  <h3 className="text-lg font-bold">選擇{type === 'general' ? '武將' : '戰法'}</h3>
                  {type === 'tactic' && selectedItems.length > 0 && (
                    <span className="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-xs font-bold">已選 {selectedItems.length}/2</span>
                  )}
                </div>
                <div className="flex gap-2">
                  {type === 'tactic' && (
                    <button onClick={() => onSelect(selectedItems.length ? selectedItems : null)} className="p-2 bg-blue-600 text-white rounded-lg"><Icon name="check" /></button>
                  )}
                  <button onClick={onClose} className="p-2 bg-gray-100 rounded-full"><Icon name="x" size={18} /></button>
                </div>
              </div>
              <div className="p-4 bg-gray-50 border-b space-y-3 shrink-0">
                <div className="relative">
                  <Icon name="search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                  <input type="text" placeholder="搜尋..." className="w-full pl-10 pr-4 py-2 border rounded-xl outline-none" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                </div>
                <div className="flex gap-2 overflow-x-auto no-scrollbar">
                  {tabs.map(tab => (
                    <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-1.5 rounded-full text-xs font-bold transition-all whitespace-nowrap ${activeTab === tab ? 'bg-gray-900 text-white' : 'bg-white border text-gray-600'}`}>
                      {tab === 'All' ? '全部' : tab}
                    </button>
                  ))}
                </div>
              </div>
              <div className="flex-1 overflow-y-auto p-4 bg-gray-100/30">
                <button onClick={() => onSelect(null)} className="w-full py-3 bg-red-50 text-red-600 rounded-xl font-bold border border-red-100 flex items-center justify-center gap-2 mb-4"><Icon name="trash" size={18}/> 移除選擇</button>
                <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                  {filteredItems.map((item, idx) => (
                    <button key={idx} onClick={() => toggleItem(item.name)} className={`flex flex-col items-center p-2 bg-white rounded-xl shadow-sm border transition-all ${selectedItems.includes(item.name) ? 'ring-4 ring-blue-500' : ''}`}>
                      <div className={`w-full aspect-square mb-2 rounded-lg flex items-center justify-center text-white font-black text-xs text-center p-1 shadow-inner ${item.color}`}>
                        {item.name.split(' ')[0]}
                      </div>
                      <span className="text-[10px] font-bold truncate w-full text-center">{item.name}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      };

      // --- 子組件: 隊伍卡片 ---
      const TeamCard = ({ index, title, team, generalCounts, tacticCounts, onSlotClick, onGeneralUpdate }) => {
        const totalCost = team.generals.reduce((sum, g) => sum + extractCost(g.name), 0);
        const totalRedness = team.generals.reduce((sum, g) => sum + g.redness, 0);

        const getGeneralStyle = (name) => {
          if (!name) return 'bg-gray-100 text-gray-400 border-dashed border-2 border-gray-300';
          const cleanName = name.split(' ')[0];
          const gen = GENERALS_DATA.find(g => g.name.startsWith(cleanName));
          const isDup = generalCounts[cleanName] > 1;
          return `${gen ? FACTION_COLORS[gen.faction] : 'bg-gray-500'} text-white shadow-md ${isDup ? 'ring-4 ring-red-500 ring-offset-2' : ''}`;
        };

        const getTacticStyle = (name) => {
          if (!name) return 'bg-gray-50 text-gray-400 border-dashed border border-gray-200';
          const tac = TACTICS_DATA.find(t => t.name === name);
          const isDup = name && tacticCounts[name] > 1;
          return `${tac ? TACTIC_COLORS[tac.type] : 'bg-gray-500'} text-white shadow-sm ${isDup ? 'ring-4 ring-red-500 ring-offset-1' : ''}`;
        };

        return (
          <div className="ios-card rounded-2xl p-5 shadow-lg border border-white/50">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-gray-400 font-bold text-xs uppercase tracking-wider">{title}</h2>
              <div className="bg-gray-900/10 px-2 py-0.5 rounded-full text-[11px] font-extrabold text-gray-700 flex gap-2">
                <span>Cost: <span className="text-blue-700 font-black">{totalCost}</span></span>
                <span className="opacity-30">|</span>
                <span>紅: <span className="text-red-700 font-black">{totalRedness}</span></span>
              </div>
            </div>
            <div className="grid grid-cols-3 gap-3">
              {team.generals.map((slot, i) => (
                <div key={i} className="flex flex-col gap-1.5">
                  <button onClick={() => onSlotClick(index, 'general', 'generals', i)} className={`relative w-full h-14 rounded-xl flex items-center justify-center font-bold text-lg transition-all active:scale-95 ${getGeneralStyle(slot.name)}`}>
                    {slot.name ? (
                      <>
                        <div className="absolute top-1 left-1 bg-black/40 text-[9px] font-bold px-1 rounded text-white">C:{extractCost(slot.name)}</div>
                        <span className="truncate px-1">{slot.name.split(' ')[0]}</span>
                      </>
                    ) : <Icon name="plus" size={24} className="opacity-30" />}
                  </button>
                  {slot.name && (
                    <div className="flex items-center justify-between px-1 h-5">
                      <button onClick={() => onGeneralUpdate(index, i, { isCollection: !slot.isCollection })} className={`w-5 h-5 rounded border text-[9px] font-bold flex items-center justify-center ${slot.isCollection ? 'bg-yellow-600 text-white border-yellow-700' : 'bg-white text-gray-300'}`}>典</button>
                      <div className="flex gap-0.5">
                        {[1, 2, 3, 4, 5].map(s => (
                          <Icon key={s} name="star" size={10} className={`${s <= slot.redness ? 'fill-red-500 text-red-500' : 'fill-gray-100 text-gray-200'} cursor-pointer`} onClick={() => onGeneralUpdate(index, i, { redness: slot.redness === s ? 0 : s })}/>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              ))}
              {team.tacticsRow1.map((tac, i) => (
                <button key={i} onClick={() => onSlotClick(index, 'tactic', 'tacticsRow1', i)} className={`w-full h-10 rounded-xl flex items-center justify-center text-[11px] font-bold transition-all active:scale-95 ${getTacticStyle(tac)}`}>
                  {tac ? <span className="truncate px-0.5">{tac}</span> : <Icon name="plus" size={16} className="opacity-30" />}
                </button>
              ))}
              {team.tacticsRow2.map((tac, i) => (
                <button key={i} onClick={() => onSlotClick(index, 'tactic', 'tacticsRow2', i)} className={`w-full h-10 rounded-xl flex items-center justify-center text-[11px] font-bold transition-all active:scale-95 ${getTacticStyle(tac)}`}>
                  {tac ? <span className="truncate px-0.5">{tac}</span> : <Icon name="plus" size={16} className="opacity-30" />}
                </button>
              ))}
            </div>
          </div>
        );
      };

      // --- 主應用程式 ---
      const App = () => {
        const createEmptyGeneral = () => ({ name: null, isCollection: false, redness: 0 });
        const createEmptyTeam = (id) => ({ id, generals: [createEmptyGeneral(), createEmptyGeneral(), createEmptyGeneral()], tacticsRow1: [null, null, null], tacticsRow2: [null, null, null] });
        
        const [teams, setTeams] = useState(Array.from({ length: 6 }, (_, i) => createEmptyTeam(i)));
        const [modal, setModal] = useState({ open: false, type: 'general', tIdx: 0, row: '', cIdx: 0 });

        // 重複檢測
        const { generalCounts, tacticCounts } = useMemo(() => {
          const gC = {}; const tC = {};
          teams.forEach(t => {
            t.generals.forEach(g => { if(g.name) { const n = g.name.split(' ')[0]; gC[n] = (gC[n] || 0) + 1; } });
            [...t.tacticsRow1, ...t.tacticsRow2].forEach(tac => { if(tac) tC[tac] = (tC[tac] || 0) + 1; });
          });
          return { generalCounts: gC, tacticCounts: tC };
        }, [teams]);

        // 載入
        useEffect(() => {
          const hash = window.location.hash;
          if (hash.length > 1) {
            try {
              const data = JSON.parse(decodeURIComponent(atob(hash.substring(1))));
              setTeams(data.map((t, idx) => ({
                id: idx,
                generals: t.g.map(g => g ? { name: g[0], isCollection: g[1]===1, redness: g[2] } : createEmptyGeneral()),
                tacticsRow1: t.t.slice(0,3), tacticsRow2: t.t.slice(3,6)
              })));
              return;
            } catch(e) {}
          }
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) {
            try {
              const data = JSON.parse(saved);
              setTeams(data.map((t, idx) => ({
                id: idx,
                generals: t.g.map(g => g ? { name: g[0], isCollection: g[1]===1, redness: g[2] } : createEmptyGeneral()),
                tacticsRow1: t.t.slice(0,3), tacticsRow2: t.t.slice(3,6)
              })));
            } catch(e) {}
          }
        }, []);

        const handleSlotClick = (tIdx, type, row, cIdx) => setModal({ open: true, type, tIdx, row, cIdx });

        const handleSelect = (vals) => {
          setTeams(prev => {
            const next = [...prev];
            const team = { ...next[modal.tIdx] };
            if (modal.row === 'generals') {
              team.generals = [...team.generals];
              team.generals[modal.cIdx] = { ...team.generals[modal.cIdx], name: vals ? vals[0] : null };
            } else {
              const r1 = [...team.tacticsRow1]; const r2 = [...team.tacticsRow2];
              if (!vals) {
                if(modal.row === 'tacticsRow1') r1[modal.cIdx] = null; else r2[modal.cIdx] = null;
              } else if (vals.length === 1) {
                if(modal.row === 'tacticsRow1') r1[modal.cIdx] = vals[0]; else r2[modal.cIdx] = vals[0];
              } else {
                r1[modal.cIdx] = vals[0]; r2[modal.cIdx] = vals[1];
              }
              team.tacticsRow1 = r1; team.tacticsRow2 = r2;
            }
            next[modal.tIdx] = team;
            return next;
          });
          setModal({ ...modal, open: false });
        };

        const handleUpdate = (tIdx, cIdx, upd) => {
          setTeams(prev => {
            const next = [...prev];
            next[tIdx].generals[cIdx] = { ...next[tIdx].generals[cIdx], ...upd };
            return next;
          });
        };

        const handleSave = () => {
          const data = teams.map(t => ({ g: t.generals.map(g => g.name ? [g.name, g.isCollection?1:0, g.redness] : null), t: [...t.tacticsRow1, ...t.tacticsRow2] }));
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          alert("已儲存！");
        };

        const handleShare = () => {
          const data = teams.map(t => ({ g: t.generals.map(g => g.name ? [g.name, g.isCollection?1:0, g.redness] : null), t: [...t.tacticsRow1, ...t.tacticsRow2] }));
          window.location.hash = btoa(encodeURIComponent(JSON.stringify(data)));
          navigator.clipboard.writeText(window.location.href).then(() => alert("分享連結已複製！"));
        };

        return (
          <div className="min-h-screen pb-10 px-4 max-w-7xl mx-auto">
            <header className="py-8 text-center">
              <h1 className="text-4xl font-black text-gray-900 mb-2 tracking-tight">三國志戰略版配將</h1>
              <p className="text-gray-500 text-sm font-medium italic">具備重複檢測與多選功能</p>
              <div className="flex flex-wrap justify-center gap-3 mt-6">
                <button onClick={handleShare} className="flex items-center gap-2 px-6 py-2.5 bg-blue-600 text-white rounded-full shadow-lg font-bold text-sm"><Icon name="share" size={16}/>分享</button>
                <button onClick={handleSave} className="flex items-center gap-2 px-6 py-2.5 bg-green-600 text-white rounded-full shadow-lg font-bold text-sm"><Icon name="save" size={16}/>儲存</button>
                <button onClick={() => { if(confirm("重置所有隊伍？")) setTeams(Array.from({ length: 6 }, (_, i) => createEmptyTeam(i))); }} className="px-6 py-2.5 border rounded-full bg-white shadow-md font-bold text-sm text-gray-600 flex items-center gap-2"><Icon name="rotate" size={16}/>重置</button>
              </div>
            </header>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {teams.map((t, i) => (
                <TeamCard key={i} index={i} title={i === 0 ? '開荒隊伍' : `隊伍 ${i}`} team={t} generalCounts={generalCounts} tacticCounts={tacticCounts} onSlotClick={handleSlotClick} onGeneralUpdate={handleUpdate} />
              ))}
            </div>
            {modal.open && <SelectionModal isOpen={modal.open} type={modal.type} onSelect={handleSelect} onClose={() => setModal({ ...modal, open: false })} />}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>