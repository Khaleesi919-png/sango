<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>三國志戰略版配將模擬器 Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              ios: {
                bg: '#F2F2F7',
                card: '#FFFFFF',
                label: '#000000',
                secondary: '#8E8E93',
                blue: '#007AFF',
                red: '#FF3B30',
                gold: '#FFCC00',
              },
              wei: '#2e58a6',
              shu: '#3b8c4d',
              wu: '#c23c3c',
              qun: '#d4a017',
              t_command: '#78808A',
              t_passive: '#9F8AC7',
              t_formation: '#C4A274',
              t_assault: '#C4788A',
              t_troop: '#6CA693',
              t_active: '#729DB3',
            },
            animation: {
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'glow-gold-pro': 'glow-gold-pro 2.5s ease-in-out infinite alternate',
              'glow-red-pro': 'glow-red-pro 1.8s ease-in-out infinite alternate',
              'fade-in': 'fadeIn 0.5s ease-out forwards',
            },
            keyframes: {
              'glow-gold-pro': {
                'from': { boxShadow: '0 0 8px rgba(255, 204, 0, 0.4)', borderColor: 'rgba(255, 204, 0, 0.5)' },
                'to': { boxShadow: '0 0 25px rgba(255, 204, 0, 0.9)', borderColor: 'rgba(255, 204, 0, 1)' }
              },
              'glow-red-pro': {
                'from': { boxShadow: '0 0 8px rgba(255, 59, 48, 0.4)', borderColor: 'rgba(255, 59, 48, 0.5)' },
                'to': { boxShadow: '0 0 25px rgba(255, 59, 48, 0.9)', borderColor: 'rgba(255, 59, 48, 1)' }
              },
              'fadeIn': {
                'from': { opacity: '0', transform: 'translateY(10px)' },
                'to': { opacity: '1', transform: 'translateY(0)' }
              }
            }
          }
        }
      }
    </script>
    
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
        background-color: #F2F2F7;
        color: #1C1C1E;
        -webkit-font-smoothing: antialiased;
        overflow-x: hidden;
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: saturate(180%) blur(25px);
        -webkit-backdrop-filter: saturate(180%) blur(25px);
        border: 1px solid rgba(0, 0, 0, 0.12);
      }
      .ios-shadow {
        box-shadow: 0 8px 40px 0 rgba(0, 0, 0, 0.1);
      }
      .ios-btn-active:active {
        transform: scale(0.96);
        opacity: 0.85;
      }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      
      @keyframes slideUp {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
      }
      .animate-ios-modal {
        animation: slideUp 0.35s cubic-bezier(0.25, 1, 0.5, 1);
      }
    </style>

    <!-- React 18 UMD -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.561.0"
  }
}
</script>
</head>
<body>
    <!-- 左上角註記 -->
    <div class="fixed top-4 left-6 z-[60] text-ios-secondary font-bold text-[10px] tracking-widest pointer-events-none opacity-60">
      Q做的
    </div>

    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
      const { useState, useMemo, useEffect } = React;

      // --- Icons ---
      const Plus = ({ size = 20, className = "", ...props }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M5 12h14"/><path d="M12 5v14"/></svg>
      );
      const Star = ({ size = 11, className = "", fill = "none", ...props }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
      );
      const X = ({ size = 24, ...props }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      );
      const Search = ({ size = 18, className = "", ...props }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
      );
      const Save = ({ size = 18, ...props }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
      );
      const Refresh = ({ size = 18, ...props }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
      );
      const CheckCircle = ({ size = 16, className = "", ...props }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
      );

      // --- Constants ---
      const Faction = { Wei: '魏', Shu: '蜀', Wu: '吳', Qun: '群' };
      const TacticType = { Command: '指揮', Passive: '被動', Formation: '陣法', Assault: '突擊', Troop: '兵種', Active: '主動' };
      const STORAGE_KEY = 'tk_builder_ios_v3_stars';

      const GENERALS_DATA = [
        { faction: Faction.Shu, name: '劉備 7' }, { faction: Faction.Shu, name: '龐統 7' }, { faction: Faction.Shu, name: '諸葛亮 7' }, { faction: Faction.Shu, name: 'SP諸葛亮 6' }, { faction: Faction.Shu, name: '關羽 7' }, { faction: Faction.Shu, name: 'SP關羽 7' }, { faction: Faction.Shu, name: 'SP黃月英 4' }, { faction: Faction.Shu, name: '黃忠 6' }, { faction: Faction.Shu, name: 'SP黃忠 6' }, { faction: Faction.Shu, name: '趙雲 6' }, { faction: Faction.Shu, name: '張飛 6' }, { faction: Faction.Shu, name: '姜維 6' }, { faction: Faction.Shu, name: '關銀屏 6' }, { faction: Faction.Shu, name: '魏延 6' }, { faction: Faction.Shu, name: '張苞 6' }, { faction: Faction.Shu, name: '關興 6' }, { faction: Faction.Shu, name: 'SP法正 6' }, { faction: Faction.Shu, name: '星彩 6' },{ faction: Faction.Shu, name: '法正 4' }, { faction: Faction.Shu, name: '王平 5' }, { faction: Faction.Shu, name: '徐庶 5' }, { faction: Faction.Shu, name: '黃月英 4' }, { faction: Faction.Shu, name: '馬超 7' }, { faction: Faction.Shu, name: 'CO關平 6' }, { faction: Faction.Shu, name: '馬雲祿 5' }, { faction: Faction.Shu, name: '陳到 6' }, { faction: Faction.Shu, name: '嚴顏 6' }, { faction: Faction.Shu, name: '伊籍 6' },
        { faction: Faction.Qun, name: 'SP馬超 7' }, { faction: Faction.Qun, name: 'SP皇甫嵩 6' }, { faction: Faction.Qun, name: 'SP袁紹 7' }, { faction: Faction.Qun, name: 'SP朱儁 6' }, { faction: Faction.Qun, name: '沮授 6' }, { faction: Faction.Qun, name: '貂蟬 4' }, { faction: Faction.Qun, name: 'SP貂蟬 6' }, { faction: Faction.Qun, name: '許攸 6' }, { faction: Faction.Qun, name: '呂布 7' }, { faction: Faction.Qun, name: '袁術 6' }, { faction: Faction.Qun, name: '公孫瓚 6' }, { faction: Faction.Qun, name: '張角 6' }, { faction: Faction.Qun, name: '于吉 7' }, { faction: Faction.Qun, name: '華佗 5' }, { faction: Faction.Qun, name: '左慈 5' }, { faction: Faction.Qun, name: '董卓 7' }, { faction: Faction.Qun, name: 'SP董卓 7' }, { faction: Faction.Qun, name: '孟獲 7' }, { faction: Faction.Qun, name: '呂玲綺 6' }, { faction: Faction.Qun, name: '祝融夫人 6' }, { faction: Faction.Qun, name: '兀突骨 6' }, { faction: Faction.Qun, name: '袁紹 6' }, { faction: Faction.Qun, name: '麴義 6' }, { faction: Faction.Qun, name: '朵思大王 6' }, { faction: Faction.Qun, name: '木鹿大王 6' }, { faction: Faction.Qun, name: '張讓 5' }, { faction: Faction.Qun, name: '李儒 5' }, { faction: Faction.Qun, name: '高順 5' }, { faction: Faction.Qun, name: '馬騰 5' }, { faction: Faction.Qun, name: '文醜 5' }, { faction: Faction.Qun, name: '華雄 5' }, { faction: Faction.Qun, name: '顏良 5' }, { faction: Faction.Qun, name: '高覽 5' }, { faction: Faction.Qun, name: '陳宮 5' }, { faction: Faction.Qun, name: '蔡文姬 3' }, { faction: Faction.Qun, name: '董白 3' }, { faction: Faction.Qun, name: 'SP張寶 6' }, { faction: Faction.Qun, name: 'SP張梁 5' }, { faction: Faction.Qun, name: '田豐 6' }, { faction: Faction.Qun, name: '兲丨Q 30' }, { faction: Faction.Qun, name: '雞枝風 3CM' }, { faction: Faction.Qun, name: '大麥克 3CM' }, { faction: Faction.Qun, name: '鄒氏 3' },
        { faction: Faction.Wu, name: '孫尚香 6' }, { faction: Faction.Wu, name: '周泰 6' }, { faction: Faction.Wu, name: '凌統 6' }, { faction: Faction.Wu, name: '陸遜 7' }, { faction: Faction.Wu, name: '魯肅 6' }, { faction: Faction.Wu, name: '周瑜 6' }, { faction: Faction.Wu, name: 'SP周瑜 6' }, { faction: Faction.Wu, name: '孫權 6' }, { faction: Faction.Wu, name: 'CO大喬 6' }, { faction: Faction.Wu, name: 'CO小喬 5' }, { faction: Faction.Wu, name: '呂蒙 6' }, { faction: Faction.Wu, name: 'SP呂蒙 7' }, { faction: Faction.Wu, name: '太史慈 6' }, { faction: Faction.Wu, name: '孫堅 6' }, { faction: Faction.Wu, name: 'SP孫堅 7' }, { faction: Faction.Wu, name: '甘寧 6' }, { faction: Faction.Wu, name: '程普 5' }, { faction: Faction.Wu, name: '陸抗 6' }, { faction: Faction.Wu, name: '黃蓋 5' }, { faction: Faction.Wu, name: '諸葛格 4' }, { faction: Faction.Wu, name: '孫策 5' },
        { faction: Faction.Wei, name: '司馬懿 7' }, { faction: Faction.Wei, name: '曹操 7' }, { faction: Faction.Wei, name: '滿寵 5' }, { faction: Faction.Wei, name: '典韋 6' }, { faction: Faction.Wei, name: 'SP典韋 6' }, { faction: Faction.Wei, name: '賈詡 7' }, { faction: Faction.Wei, name: 'SP荀彧 7' }, { faction: Faction.Wei, name: 'SP郭嘉 6' }, { faction: Faction.Wei, name: '荀攸 6' }, { faction: Faction.Wei, name: '張遼 7' }, { faction: Faction.Wei, name: '王元姬 5' }, { faction: Faction.Wei, name: '郭嘉 5' }, { faction: Faction.Wei, name: '王異 6' }, { faction: Faction.Wei, name: '龐德 5' }, { faction: Faction.Wei, name: 'SP龐德 6' }, { faction: Faction.Wei, name: 'CO曹丕 7' }, { faction: Faction.Wei, name: '郝昭 5' }, { faction: Faction.Wei, name: '曹仁 6' }, { faction: Faction.Wei, name: 'CO甄姬 5' }, { faction: Faction.Wei, name: '程昱 5' }, { faction: Faction.Wei, name: '許褚 6' }, { faction: Faction.Wei, name: '張郃 6' }, { faction: Faction.Wei, name: '徐晃 6' }, { faction: Faction.Wei, name: '夏侯惇 6' }, { faction: Faction.Wei, name: '鍾會 6' }, { faction: Faction.Wei, name: '王雙 5' }, { faction: Faction.Wei, name: '曹純 5' }, { faction: Faction.Wei, name: '于禁 5' }, { faction: Faction.Wei, name: '樂進 5' }, { faction: Faction.Wei, name: '鄧艾 5' }, { faction: Faction.Wei, name: '夏侯淵 5' }, { faction: Faction.Wei, name: '張春華 3' }, { faction: Faction.Wei, name: 'SP劉曄 6' }, { faction: Faction.Wei, name: 'SP曹真 6' }
      ];

      const TACTICS_DATA = [
        { type: TacticType.Command, name: '虛實奇謀' }, { type: TacticType.Command, name: '深謀遠慮' }, { type: TacticType.Command, name: '蓄勢待發' }, { type: TacticType.Command, name: '暫避其鋒' }, { type: TacticType.Command, name: '轉.暫避統' }, { type: TacticType.Command, name: '盛氣淩敵' }, { type: TacticType.Command, name: '用武神通' }, { type: TacticType.Command, name: '轉.用武武' }, { type: TacticType.Command, name: '夢中弒臣' }, { type: TacticType.Command, name: '挫銳' }, { type: TacticType.Command, name: '非攻制勝' }, { type: TacticType.Command, name: '轉.非攻智' }, { type: TacticType.Command, name: '鐵騎驅馳' }, { type: TacticType.Command, name: '撫輯軍民' }, { type: TacticType.Command, name: '轉.撫輯智' },{ type: TacticType.Command, name: '禦敵屏障' }, { type: TacticType.Command, name: '長者之風' }, { type: TacticType.Command, name: '鋒芒畢露' }, { type: TacticType.Command, name: '整裝待發' }, { type: TacticType.Command, name: '義心昭烈' }, { type: TacticType.Command, name: '奇計良謀' }, { type: TacticType.Command, name: '橫戈躍馬' }, { type: TacticType.Command, name: '整軍經武' }, { type: TacticType.Command, name: '剛柔並濟' }, { type: TacticType.Command, name: '眾志成城' }, { type: TacticType.Command, name: '轉.眾志武' },{ type: TacticType.Command, name: '知己知彼' },
        { type: TacticType.Passive, name: '功不唐捐' }, { type: TacticType.Passive, name: '整軍經武' }, { type: TacticType.Passive, name: '千里走單騎' }, { type: TacticType.Passive, name: '魅惑' }, { type: TacticType.Passive, name: '合軍聚眾' }, { type: TacticType.Passive, name: '忠勇益烈' }, { type: TacticType.Passive, name: '文武雙全' }, { type: TacticType.Passive, name: '以寡擊眾' }, { type: TacticType.Passive, name: '絕地反擊' }, { type: TacticType.Passive, name: '士爭先赴' }, { type: TacticType.Passive, name: '裸衣血戰' }, { type: TacticType.Passive, name: '血刃爭鋒' }, { type: TacticType.Passive, name: '眾動萬計' }, { type: TacticType.Passive, name: '太平道法' }, { type: TacticType.Passive, name: '自癒' }, { type: TacticType.Passive, name: '後發制人' }, { type: TacticType.Passive, name: '氣凌三軍' }, { type: TacticType.Passive, name: '虎踞鷹揚' }, { type: TacticType.Passive, name: '引弦力戰' }, { type: TacticType.Passive, name: '剛勇無前' }, { type: TacticType.Passive, name: '騎虎難下' }, { type: TacticType.Passive, name: '白眉' }, { type: TacticType.Passive, name: '兵無常勢' }, { type: TacticType.Passive, name: '士別三日' }, { type: TacticType.Passive, name: '乘勝長驅' },
        { type: TacticType.Formation, name: '潛龍陣' }, { type: TacticType.Formation, name: '鋒矢陣' }, { type: TacticType.Formation, name: '八門金鎖陣' }, { type: TacticType.Formation, name: '箕形陣' }, { type: TacticType.Formation, name: '三勢陣' }, { type: TacticType.Formation, name: '行一陣' }, { type: TacticType.Formation, name: '武鋒陣' }, { type: TacticType.Formation, name: '長蛇陣' }, { type: TacticType.Formation, name: '魚鱗陣' },
        { type: TacticType.Assault, name: '摧鋒斷刃' }, { type: TacticType.Assault, name: '折衝禦侮' }, { type: TacticType.Assault, name: '暴戾無仁' }, { type: TacticType.Assault, name: '一騎當千' }, { type: TacticType.Assault, name: '百騎劫營' }, { type: TacticType.Assault, name: '當鋒摧決' }, { type: TacticType.Assault, name: '速乘其利' }, { type: TacticType.Assault, name: '彎弓飲羽' }, { type: TacticType.Assault, name: '鬼神霆威' }, { type: TacticType.Assault, name: '破甲' }, { type: TacticType.Assault, name: '克敵制勝' }, { type: TacticType.Assault, name: '先成其慮' }, { type: TacticType.Assault, name: '勇者得前' }, { type: TacticType.Assault, name: '左右開弓' }, { type: TacticType.Assault, name: '手起刀落' },
        { type: TacticType.Troop, name: '虎豹騎' }, { type: TacticType.Troop, name: '大戟士' }, { type: TacticType.Troop, name: '藤甲兵' }, { type: TacticType.Troop, name: '白馬義從' }, { type: TacticType.Troop, name: '先登士死' }, { type: TacticType.Troop, name: '陷陣營' }, { type: TacticType.Troop, name: '西涼鐵騎' }, { type: TacticType.Troop, name: '解煩衛' }, { type: TacticType.Troop, name: '錦帆軍' }, { type: TacticType.Troop, name: '飛熊軍' }, { type: TacticType.Troop, name: '象兵' }, { type: TacticType.Troop, name: '青州兵' }, { type: TacticType.Troop, name: '虎衛軍' }, { type: TacticType.Troop, name: '白毦兵' }, { type: TacticType.Troop, name: '無當飛軍' }, { type: TacticType.Troop, name: '丹陽兵' },
        { type: TacticType.Active, name: '偽書相間' }, { type: TacticType.Active, name: '挾勢弄權' }, { type: TacticType.Active, name: '奪魂挾魄' }, { type: TacticType.Active, name: '轉.奪魂武' }, { type: TacticType.Active, name: '草船借箭' }, { type: TacticType.Active, name: '刮骨療傷' }, { type: TacticType.Active, name: '轉.刮骨統' },{ type: TacticType.Active, name: '嬰城自守' }, { type: TacticType.Active, name: '坐守孤城' }, { type: TacticType.Active, name: '杯蛇鬼車' }, { type: TacticType.Active, name: '竭力佐謀' }, { type: TacticType.Active, name: '因利制權' }, { type: TacticType.Active, name: '誘敵深入' }, { type: TacticType.Active, name: '威謀靡亢' }, { type: TacticType.Active, name: '挫志怒襲' }, { type: TacticType.Active, name: '乘敵不虞' }, { type: TacticType.Active, name: '傾國傾城' }, { type: TacticType.Active, name: '益其金鼓' }, { type: TacticType.Active, name: '定謀貴決' }, { type: TacticType.Active, name: '結盟' }, { type: TacticType.Active, name: '臨機制勝' }, { type: TacticType.Active, name: '熯天熾熱' }, { type: TacticType.Active, name: '火熾原燎' }, { type: TacticType.Active, name: '風助火勢' }, { type: TacticType.Active, name: '智計' }, { type: TacticType.Active, name: '兵鋒' }, { type: TacticType.Active, name: '上兵伐謀' }, { type: TacticType.Active, name: '破軍威勝' }, { type: TacticType.Active, name: '掣刀斫敵' }, { type: TacticType.Active, name: '臥薪嘗膽' }, { type: TacticType.Active, name: '縱兵劫掠' }, { type: TacticType.Active, name: '橫掃千軍' }, { type: TacticType.Active, name: '轉.橫掃智' },  { type: TacticType.Active, name: '疾風驟雨' },{ type: TacticType.Active, name: '焚輜營壘' }, { type: TacticType.Active, name: '萬軍奪帥' }, { type: TacticType.Active, name: '靈機一動' }, { type: TacticType.Active, name: '謬力同心' }, { type: TacticType.Active, name: '強攻' }, { type: TacticType.Active, name: '淨化' }, { type: TacticType.Active, name: '驅散' }, { type: TacticType.Active, name: '魯莽' }, { type: TacticType.Active, name: '運籌決算' }, { type: TacticType.Active, name: '屠几上肉' }, { type: TacticType.Active, name: '焰逐風飛' }, { type: TacticType.Active, name: '形機軍略' }, { type: TacticType.Active, name: '落鳳' }, { type: TacticType.Active, name: '避實擊虛' }, { type: TacticType.Active, name: '輕勇飛燕' }, { type: TacticType.Active, name: '擊其惰歸' }, { type: TacticType.Active, name: '決水潰城' }, { type: TacticType.Active, name: '絕其汲道' }, { type: TacticType.Active, name: '據水斷橋' }, { type: TacticType.Active, name: '機略縱橫' }, { type: TacticType.Active, name: '見機行事' }, { type: TacticType.Active, name: '聲東擊西' }, { type: TacticType.Active, name: '矢志不移' }, { type: TacticType.Active, name: '黃天泰平' }, { type: TacticType.Active, name: '瞋目橫矛' }, { type: TacticType.Active, name: '料事如神' }, { type: TacticType.Active, name: '落雷' }, { type: TacticType.Active, name: '驍勇善戰' }, { type: TacticType.Active, name: '一力拒守' }, { type: TacticType.Active, name: '守而必固' }, { type: TacticType.Active, name: '唇槍舌戰' }, { type: TacticType.Active, name: '舌戰群儒' }, { type: TacticType.Active, name: '獨行赴斗' }, { type: TacticType.Active, name: '四面楚歌' }, { type: TacticType.Active, name: '沉沙決水' }, { type: TacticType.Active, name: '風聲鶴唳' }, { type: TacticType.Active, name: '萬箭齊發' }, { type: TacticType.Active, name: '所向批靡' }, { type: TacticType.Active, name: '破陣摧堅' }
      ];

      const FACTION_COLORS = { [Faction.Wei]: 'bg-wei', [Faction.Shu]: 'bg-shu', [Faction.Wu]: 'bg-wu', [Faction.Qun]: 'bg-qun' };
      const TACTIC_COLORS = { [TacticType.Command]: 'bg-t_command', [TacticType.Passive]: 'bg-t_passive', [TacticType.Formation]: 'bg-t_formation', [TacticType.Assault]: 'bg-t_assault', [TacticType.Troop]: 'bg-t_troop', [TacticType.Active]: 'bg-t_active' };

      const extractCost = (name) => {
        if (!name) return 0;
        const match = name.match(/\d+$/);
        return match ? parseInt(match[0], 10) : 0;
      };

      // --- Components ---
      const SelectionModal = ({ isOpen, type, currentValue, onClose, onSelect }) => {
        const [activeTab, setActiveTab] = useState('全部');
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedItems, setSelectedItems] = useState([]);

        useEffect(() => {
          if (isOpen) {
            setSelectedItems(currentValue ? [currentValue] : []);
          }
        }, [isOpen, currentValue]);

        const tabs = useMemo(() => type === 'general' ? ['全部', ...Object.values(Faction)] : ['全部', ...Object.values(TacticType)], [type]);
        
        const filteredItems = useMemo(() => {
          let items = type === 'general' 
            ? GENERALS_DATA.map(g => ({ name: g.name, category: g.faction, color: FACTION_COLORS[g.faction] }))
            : TACTICS_DATA.map(t => ({ name: t.name, category: t.type, color: TACTIC_COLORS[t.type] }));
          if (activeTab !== '全部') items = items.filter(i => i.category === activeTab);
          if (searchTerm) items = items.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase()));
          return items;
        }, [type, activeTab, searchTerm]);

        const handleItemClick = (name) => {
          if (type === 'general') {
            onSelect([name]);
          } else {
            setSelectedItems(prev => {
              if (prev.includes(name)) return prev.filter(i => i !== name);
              if (prev.length >= 2) return [prev[1], name];
              return [...prev, name];
            });
          }
        };

        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 z-[100] flex items-end sm:items-center justify-center">
            <div className="absolute inset-0 bg-black/40 backdrop-blur-md" onClick={onClose} />
            <div className="relative w-full max-w-2xl bg-ios-bg sm:rounded-3xl rounded-t-3xl shadow-[0_20px_60px_-15px_rgba(0,0,0,0.35)] flex flex-col max-h-[92vh] animate-ios-modal overflow-hidden">
              <div className="px-5 py-3 flex items-center justify-between shrink-0 bg-white/95 backdrop-blur-xl border-b border-gray-200">
                <div className="flex flex-col">
                  <h3 className="text-lg font-bold tracking-tight">選擇{type === 'general' ? '武將' : '戰法'}</h3>
                  <p className="text-[10px] text-ios-secondary font-bold uppercase tracking-widest leading-none">
                    {type === 'tactic' && selectedItems.length > 0 ? `已選 ${selectedItems.length}/2` : `Select`}
                  </p>
                </div>
                <div className="flex items-center gap-2">
                  {type === 'tactic' && selectedItems.length > 0 && (
                    <button onClick={() => onSelect(selectedItems)} className="px-4 py-1.5 bg-ios-blue text-white rounded-full font-bold text-xs ios-btn-active shadow-lg shadow-ios-blue/20">確認</button>
                  )}
                  <button onClick={onClose} className="w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 rounded-full text-gray-500 ios-btn-active transition-colors"><X size={18}/></button>
                </div>
              </div>
              <div className="p-3 space-y-3 bg-white/50">
                <div className="relative">
                  <Search className="absolute left-3.5 top-1/2 -translate-y-1/2 text-ios-secondary" size={16} />
                  <input type="text" placeholder="搜尋關鍵字..." className="w-full pl-10 pr-4 py-2 bg-gray-100 rounded-xl outline-none border-2 border-transparent focus:border-ios-blue focus:bg-white transition-all shadow-inner text-sm" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                </div>
                <div className="flex gap-2 overflow-x-auto no-scrollbar py-1">
                  {tabs.map(tab => (
                    <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-all shadow-sm ${activeTab === tab ? 'bg-ios-blue text-white' : 'bg-white text-ios-secondary hover:bg-gray-100 border border-gray-200'}`}>
                      {tab}
                    </button>
                  ))}
                </div>
              </div>
              <div className="flex-1 overflow-y-auto p-4 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                {filteredItems.map((item, idx) => {
                  const isSelected = selectedItems.includes(item.name);
                  return (
                    <button 
                      key={idx} 
                      onClick={() => handleItemClick(item.name)} 
                      className={`group relative flex flex-col items-center p-2.5 bg-white rounded-2xl transition-all ios-btn-active border-2 ${isSelected ? 'border-ios-blue ring-4 ring-ios-blue/10 scale-[1.05] z-10 shadow-lg' : 'border-gray-200 shadow-sm hover:shadow-md hover:border-gray-400'}`}
                    >
                      {isSelected && (
                        <div className="absolute -top-1.5 -right-1.5 bg-ios-blue text-white rounded-full p-0.5 shadow-md border-2 border-white z-20">
                          <CheckCircle size={12} />
                        </div>
                      )}
                      <div className={`w-full aspect-[4/5] mb-1.5 rounded-xl flex items-center justify-center text-white font-black text-xs text-center ${item.color} p-1.5 shadow-inner transition-transform group-hover:scale-[1.02]`}>
                        {item.name.split(' ')[0]}
                      </div>
                      <span className={`text-[10px] font-bold truncate w-full text-center transition-colors ${isSelected ? 'text-ios-blue' : 'text-ios-label'}`}>{item.name}</span>
                    </button>
                  );
                })}
              </div>
              <div className="p-3 bg-white border-t border-gray-100 text-center">
                <button onClick={() => onSelect(null)} className="text-ios-red text-xs font-bold py-1.5 px-5 rounded-full hover:bg-ios-red/5 transition-colors">清除選擇</button>
              </div>
            </div>
          </div>
        );
      };

      const TeamCard = ({ index, team, globalCounts, onSlotClick, onUpdate }) => {
        const totalCost = team.generals.reduce((sum, g) => sum + extractCost(g.name), 0);
        const totalRed = team.generals.reduce((sum, g) => sum + g.redness, 0);

        const getGStyle = (slot) => {
          if (!slot.name) return 'bg-gray-100/60 border-gray-400 border-2 border-dashed text-gray-400 hover:bg-gray-100 hover:border-gray-500';
          const cleanName = slot.name.split(' ')[0];
          const gen = GENERALS_DATA.find(g => g.name.startsWith(cleanName));
          const isDup = globalCounts.gC[cleanName] > 1;
          
          let style = gen ? FACTION_COLORS[gen.faction] : 'bg-gray-400';
          style += ' text-white shadow-lg';
          
          if (slot.isDynamic) style += ' animate-glow-gold-pro border-2';
          else if (isDup) style += ' animate-glow-red-pro border-2';
          else style += ' border-transparent border-2';

          return style;
        };

        const getTStyle = (name) => {
          if (!name) return 'bg-gray-50/70 border-gray-400 border border-dashed text-gray-500 hover:border-gray-600';
          const t = TACTICS_DATA.find(x => x.name === name);
          const isDup = name && globalCounts.tC[name] > 1;
          const baseColor = t ? TACTIC_COLORS[t.type] : 'bg-gray-400';
          
          let classes = `${baseColor} text-white shadow-md border-2 transition-all`;
          if (isDup) classes += ' animate-glow-red-pro scale-[1.03] z-10';
          else classes += ' border-transparent';
          
          return classes;
        };

        return (
          <div className="glass-card rounded-[2rem] p-5 ios-shadow animate-fade-in flex flex-col gap-4 border-2 border-white">
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-xl font-black tracking-tighter text-ios-label">隊伍 {index + 1}</h2>
                <div className="w-8 h-1 bg-ios-blue rounded-full mt-1 opacity-20"></div>
              </div>
              <div className="flex gap-1.5">
                <div className="bg-ios-blue/10 px-3 py-1 rounded-full border border-ios-blue/10 shadow-sm"><span className="text-[10px] font-black text-ios-blue uppercase tracking-tight">Cost {totalCost}</span></div>
                <div className="bg-ios-red/10 px-3 py-1 rounded-full border border-ios-red/10 shadow-sm"><span className="text-[10px] font-black text-ios-red uppercase tracking-tight">紅 {totalRed}</span></div>
              </div>
            </div>

            <div className="grid grid-cols-3 gap-4">
              {team.generals.map((g, i) => (
                <div key={i} className="flex flex-col gap-2">
                  <button 
                    onClick={() => onSlotClick(index, 'general', 'generals', i, g.name)}
                    className={`relative w-full aspect-[3/4.4] rounded-[1.5rem] flex items-center justify-center font-black text-xl transition-all ios-btn-active ${getGStyle(g)}`}
                  >
                    {g.name ? (
                      <>
                        <div className="absolute top-2.5 left-2.5 bg-black/40 backdrop-blur-md px-1.5 py-0.5 rounded text-ios-gold font-black text-[12px] shadow-sm border border-white/20 leading-none">{extractCost(g.name)}</div>
                        <span className="drop-shadow-lg text-center leading-[1.1] tracking-tighter px-1.5">{g.name.split(' ')[0]}</span>
                      </>
                    ) : (
                      <div className="flex flex-col items-center gap-1 opacity-30">
                        <Plus size={20} />
                        <span className="text-[9px] font-bold">選擇</span>
                      </div>
                    )}
                  </button>
                  {g.name && (
                    <div className="space-y-1.5 px-0.5">
                      <div className="flex justify-center gap-1.5">
                        <button onClick={() => onUpdate(index, i, { isCollection: !g.isCollection })} className={`w-7 h-7 rounded-lg border-2 text-[10px] font-black flex items-center justify-center transition-all ios-btn-active ${g.isCollection ? 'bg-ios-gold text-white border-ios-gold shadow-md shadow-ios-gold/30' : 'bg-white text-gray-400 border-gray-300 shadow-sm hover:border-gray-500'}`}>典</button>
                        <button onClick={() => onUpdate(index, i, { isDynamic: !g.isDynamic })} className={`w-7 h-7 rounded-lg border-2 text-[10px] font-black flex items-center justify-center transition-all ios-btn-active ${g.isDynamic ? 'bg-amber-500 text-white border-amber-500 shadow-md shadow-amber-500/30' : 'bg-white text-gray-400 border-gray-300 shadow-sm hover:border-gray-500'}`}>動</button>
                      </div>
                      <div className="flex justify-center gap-0.5">
                        {[1, 2, 3, 4, 5].map(s => (
                          <Star 
                            key={s} 
                            size={32} 
                            className={`cursor-pointer transition-all hover:scale-110 p-0.5 ${s <= g.redness ? 'text-ios-red fill-ios-red drop-shadow-[0_0_8px_rgba(255,59,48,0.5)]' : 'text-gray-200 fill-gray-100'}`} 
                            onClick={(e) => {
                              e.stopPropagation();
                              onUpdate(index, i, { redness: g.redness === s ? 0 : s });
                            }} 
                          />
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              ))}
            </div>

            <div className="grid grid-cols-3 gap-2.5 pt-1">
              {[...team.tacticsRow1, ...team.tacticsRow2].map((tac, i) => (
                <button 
                  key={i} 
                  onClick={() => onSlotClick(index, 'tactic', i < 3 ? 'tacticsRow1' : 'tacticsRow2', i % 3, tac)}
                  className={`w-full h-12 rounded-xl flex items-center justify-center text-[10px] font-black px-1.5 text-center leading-snug ios-btn-active ${getTStyle(tac)} shadow-md shadow-black/5`}
                >
                  {tac || <div className="opacity-30"><Plus size={16}/></div>}
                </button>
              ))}
            </div>
          </div>
        );
      };

      // --- Main App ---
      const App = () => {
        const createEmptyTeam = (id) => ({ id, generals: Array(3).fill(null).map(() => ({ name: null, isCollection: false, isDynamic: false, redness: 0 })), tacticsRow1: Array(3).fill(null), tacticsRow2: Array(3).fill(null) });
        
        const [teams, setTeams] = useState(Array.from({ length: 12 }, (_, i) => createEmptyTeam(i)));
        const [activePage, setActivePage] = useState(0); // 0: 1-6, 1: 7-12
        const [modal, setModal] = useState(null);

        useEffect(() => {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) {
            try {
              const data = JSON.parse(saved);
              if (data.length === 12) setTeams(data);
            } catch (e) {}
          }
        }, []);

        const counts = useMemo(() => {
          const gC = {}; const tC = {};
          teams.forEach(t => {
            t.generals.forEach(g => { if(g.name) { const n = g.name.split(' ')[0]; gC[n] = (gC[n] || 0) + 1; } });
            [...t.tacticsRow1, ...t.tacticsRow2].forEach(tac => { if(tac) tC[tac] = (tC[tac] || 0) + 1; });
          });
          return { gC, tC };
        }, [teams]);

        const handleSelect = (vals) => {
          if (!modal) return;
          const { teamIdx, row, colIdx, type } = modal;
          setTeams(prev => {
            const next = JSON.parse(JSON.stringify(prev));
            if (row === 'generals') {
              next[teamIdx].generals[colIdx].name = vals ? vals[0] : null;
            } else {
              // 戰法多選邏輯
              if (type === 'tactic' && vals && vals.length >= 1) {
                next[teamIdx][row][colIdx] = vals[0];
                if (vals.length === 2) {
                   const secondRow = row === 'tacticsRow1' ? 'tacticsRow2' : 'tacticsRow1';
                   next[teamIdx][secondRow][colIdx] = vals[1];
                }
              } else {
                next[teamIdx][row][colIdx] = vals ? vals[0] : null;
              }
            }
            return next;
          });
          setModal(null);
        };

        const handleUpdate = (tIdx, cIdx, upd) => {
          setTeams(prev => {
            const next = JSON.parse(JSON.stringify(prev));
            next[tIdx].generals[cIdx] = { ...next[tIdx].generals[cIdx], ...upd };
            return next;
          });
        };

        const currentTeams = teams.slice(activePage * 6, (activePage + 1) * 6);

        return (
          <div className="min-h-screen pb-20">
            <header className="py-3 px-6 sticky top-0 z-40 bg-ios-bg/90 backdrop-blur-2xl border-b border-gray-300/40 shadow-sm">
              <div className="max-w-7xl mx-auto flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div className="flex items-baseline gap-2">
                  <h1 className="text-2xl font-black tracking-tighter text-ios-label leading-none">配將模擬器</h1>
                  <div className="font-bold text-[10px] tracking-wide uppercase hidden md:block leading-none">
                    <span className="text-ios-secondary opacity-60">Strategy Builder Pro</span>
                    <span className="text-ios-red ml-1">Q喝杯茶做的</span>
                  </div>
                </div>
                
                <div className="flex flex-row items-center gap-4">
                  <div className="flex p-1 bg-gray-200/50 rounded-xl shadow-inner border border-gray-300/50 scale-90 sm:scale-100 origin-right">
                    <button onClick={() => setActivePage(0)} className={`px-4 py-1.5 rounded-lg text-xs font-black transition-all ${activePage === 0 ? 'bg-white text-ios-blue shadow-sm' : 'text-ios-secondary hover:text-gray-700'}`}>1-6</button>
                    <button onClick={() => setActivePage(1)} className={`px-4 py-1.5 rounded-lg text-xs font-black transition-all ${activePage === 1 ? 'bg-white text-ios-blue shadow-sm' : 'text-ios-secondary hover:text-gray-700'}`}>7-12</button>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={() => { localStorage.setItem(STORAGE_KEY, JSON.stringify(teams)); alert('儲存配置成功'); }} className="flex items-center gap-1.5 px-4 py-1.5 bg-ios-blue text-white rounded-xl text-xs font-black shadow-lg shadow-ios-blue/30 ios-btn-active leading-none"><Save size={14}/> 儲存</button>
                    <button onClick={() => confirm('確認重置所有隊伍配置嗎？') && setTeams(Array.from({ length: 12 }, (_, i) => createEmptyTeam(i)))} className="p-1.5 bg-white border border-gray-200 rounded-xl text-ios-secondary shadow-sm ios-btn-active hover:bg-gray-50 leading-none"><Refresh size={16}/></button>
                  </div>
                </div>
              </div>
            </header>

            <main className="max-w-7xl mx-auto px-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-6">
              {currentTeams.map((team, i) => (
                <TeamCard 
                  key={team.id} 
                  index={activePage * 6 + i} 
                  team={team} 
                  globalCounts={counts} 
                  onSlotClick={(tIdx, type, row, colIdx, val) => setModal({ teamIdx: tIdx, type, row, colIdx, val })}
                  onUpdate={handleUpdate}
                />
              ))}
            </main>

            {modal && (
              <SelectionModal 
                isOpen={!!modal} 
                type={modal.type} 
                currentValue={modal.val} 
                onClose={() => setModal(null)} 
                onSelect={handleSelect} 
              />
            )}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>
